<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
    
  
  <link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />







  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/icon128.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/icon32.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/icon16.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="学习," />










<meta name="description" content="练习1：理解通过make生成执行文件的过程。 列出本实验各练习中对应的OS原理的知识点，并说明本实验中的实现部分如何对应和体现了原理中的基本概念和关键知识点">
<meta property="og:type" content="article">
<meta property="og:title" content="ucoreOS lab1 实验报告">
<meta property="og:url" content="https://mingkwind.github.io/posts/335ac3b4/index.html">
<meta property="og:site_name" content="风屿の博客">
<meta property="og:description" content="练习1：理解通过make生成执行文件的过程。 列出本实验各练习中对应的OS原理的知识点，并说明本实验中的实现部分如何对应和体现了原理中的基本概念和关键知识点">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="og:image" content="https://mingkwind.github.io/images/loading.gif">
<meta property="article:published_time" content="2020-03-13T02:07:09.000Z">
<meta property="article:modified_time" content="2022-04-09T15:16:20.585Z">
<meta property="article:author" content="Mingkwind">
<meta property="article:tag" content="学习">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mingkwind.github.io/images/loading.gif">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"flipYIn","post_header":"perspectiveRightIn","post_body":"perspectiveLeftIn","coll_header":"perspectiveDownIn","sidebar":"perspectiveUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://mingkwind.github.io/posts/335ac3b4/"/>





  <title>ucoreOS lab1 实验报告 | 风屿の博客</title>
  








<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="风屿の博客" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
	<a href="https://github.com/mingkwind" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#70B7FD; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">风屿の博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://mingkwind.github.io/posts/335ac3b4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mingkwind">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风屿の博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ucoreOS lab1 实验报告</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-13T10:07:09+08:00">
                2020-03-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  15k
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="练习1理解通过make生成执行文件的过程"><a class="markdownIt-Anchor" href="#练习1理解通过make生成执行文件的过程"></a> 练习1：理解通过make生成执行文件的过程。</h1>
<p>列出本实验各练习中对应的OS原理的知识点，并说明本实验中的实现部分如何对应和体现了原理中的基本概念和关键知识点<a id="more"></a></p>
<p>在此练习中，大家需要通过静态分析代码来了解：</p>
<ol>
<li>
<p>操作系统镜像文件ucore.img是如何一步一步生成的？(需要比较详细地解释Makefile中每一条相关命令和命令参数的含义，以及说明命令导致的结果)</p>
<p>进入lab1目录下运行<code>make</code>，会在<code>bin</code>文件夹下生成<code>ucore.img</code></p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="BASH"><figure class="iseeu highlight /bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">moocos-&gt; <span class="built_in">pwd</span></span><br><span class="line">/home/moocos/Desktop/ucore_lab/labcodes/lab1</span><br><span class="line">[~/Desktop/ucore_lab/labcodes/lab1]</span><br><span class="line">moocos-&gt; ls</span><br><span class="line">boot  kern  libs  Makefile  q.log  tools</span><br><span class="line">[~/Desktop/ucore_lab/labcodes/lab1]</span><br><span class="line">moocos-&gt; make</span><br><span class="line">+ cc kern/init/init.c</span><br><span class="line">kern/init/init.c:95:1: warning: ‘lab1_switch_test’ defined but not used [-Wunused                                                                                       -<span class="keyword">function</span>]</span><br><span class="line"> lab1_switch_test(void) &#123;</span><br><span class="line"> ^</span><br><span class="line">+ cc kern/libs/readline.c</span><br><span class="line">+ cc kern/libs/stdio.c</span><br><span class="line">+ cc kern/debug/kdebug.c</span><br><span class="line">kern/debug/kdebug.c:251:1: warning: ‘read_eip’ defined but not used [-Wunused-fun                                                                                       ction]</span><br><span class="line"> read_eip(void) &#123;</span><br><span class="line"> ^</span><br><span class="line">+ cc kern/debug/kmonitor.c</span><br><span class="line">+ cc kern/debug/panic.c</span><br><span class="line">+ cc kern/driver/clock.c</span><br><span class="line">+ cc kern/driver/console.c</span><br><span class="line">+ cc kern/driver/intr.c</span><br><span class="line">+ cc kern/driver/picirq.c</span><br><span class="line">+ cc kern/<span class="built_in">trap</span>/trap.c</span><br><span class="line">kern/<span class="built_in">trap</span>/trap.c:14:13: warning: ‘print_ticks’ defined but not used [-Wunused-fun                                                                                       ction]</span><br><span class="line"> static void <span class="function"><span class="title">print_ticks</span></span>() &#123;</span><br><span class="line">             ^</span><br><span class="line">kern/<span class="built_in">trap</span>/trap.c:30:26: warning: ‘idt_pd’ defined but not used [-Wunused-variable                                                                                       ]</span><br><span class="line"> static struct pseudodesc idt_pd = &#123;</span><br><span class="line">                          ^</span><br><span class="line">+ cc kern/<span class="built_in">trap</span>/trapentry.S</span><br><span class="line">+ cc kern/<span class="built_in">trap</span>/vectors.S</span><br><span class="line">+ cc kern/mm/pmm.c</span><br><span class="line">+ cc libs/printfmt.c</span><br><span class="line">+ cc libs/string.c</span><br><span class="line">+ ld bin/kernel</span><br><span class="line">+ cc boot/bootasm.S</span><br><span class="line">+ cc boot/bootmain.c</span><br><span class="line">+ cc tools/sign.c</span><br><span class="line">+ ld bin/bootblock</span><br><span class="line"><span class="string">'obj/bootblock.out'</span> size: 472 bytes</span><br><span class="line">build 512 bytes boot sector: <span class="string">'bin/bootblock'</span> success!</span><br><span class="line">10000+0 records <span class="keyword">in</span></span><br><span class="line">10000+0 records out</span><br><span class="line">5120000 bytes (5.1 MB) copied, 0.0179732 s, 285 MB/s</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes (512 B) copied, 0.000302065 s, 1.7 MB/s</span><br><span class="line">138+1 records <span class="keyword">in</span></span><br><span class="line">138+1 records out</span><br><span class="line">70775 bytes (71 kB) copied, 0.000541628 s, 131 MB/s</span><br><span class="line">[~/Desktop/ucore_lab/labcodes/lab1]</span><br><span class="line">moocos-&gt; ls</span><br><span class="line">bin  boot  kern  libs  Makefile  obj  q.log  tools</span><br><span class="line">[~/Desktop/ucore_lab/labcodes/lab1]</span><br><span class="line">moocos-&gt; ls bin/</span><br><span class="line">bootblock  kernel  sign  ucore.img</span><br><span class="line">moocos-&gt; ls obj/</span><br><span class="line">boot           bootblock.o    kern        kernel.sym  sign</span><br><span class="line">bootblock.asm  bootblock.out  kernel.asm  libs</span><br><span class="line">[~/Desktop/ucore_lab/labcodes/lab1]</span><br><span class="line">moocos-&gt; <span class="built_in">cd</span> ..</span><br><span class="line">[~/Desktop/ucore_lab/labcodes]</span><br><span class="line">moocos-&gt; diff -r lab1 ~/moocos/ucore_lab/labcodes/lab1 <span class="comment">#比较文件</span></span><br><span class="line">Only <span class="keyword">in</span> lab1: bin</span><br><span class="line">Only <span class="keyword">in</span> lab1: obj</span><br></pre></td></tr></table></figure></div>
<p>从上面<code>diff</code>命令可以看到，唯一不同于原文件的是生成了bin文件夹和obj文件夹</p>
</li>
</ol>
<p>查看Makefile内容</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="MAKEFILE"><figure class="iseeu highlight /makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line">PROJ    := challenge</span><br><span class="line">EMPTY   :=</span><br><span class="line">SPACE   := <span class="variable">$(EMPTY)</span> <span class="variable">$(EMPTY)</span></span><br><span class="line">SLASH   := /</span><br><span class="line"></span><br><span class="line">V       := @</span><br><span class="line"><span class="comment">#need llvm/cang-3.5+</span></span><br><span class="line"><span class="comment">#USELLVM := 1</span></span><br><span class="line"><span class="comment"># try to infer the correct GCCPREFX</span></span><br><span class="line"><span class="keyword">ifndef</span> GCCPREFIX</span><br><span class="line">GCCPREFIX := <span class="variable">$(<span class="built_in">shell</span> <span class="built_in">if</span> i386-elf-objdump -i 2&gt;&amp;1 | grep '^elf32-i386$$' &gt;/dev/null 2&gt;&amp;1; \</span></span><br><span class="line"><span class="variable">        then echo 'i386-elf-'; \</span></span><br><span class="line"><span class="variable">        elif objdump -i 2&gt;&amp;1 | grep 'elf32-i386' &gt;/dev/null 2&gt;&amp;1; \</span></span><br><span class="line"><span class="variable">        then echo ''; \</span></span><br><span class="line"><span class="variable">        else echo "***" 1&gt;&amp;2; \</span></span><br><span class="line"><span class="variable">        echo "*** Error: Couldn't find an i386-elf version of GCC/binutils." 1&gt;&amp;2; \</span></span><br><span class="line"><span class="variable">        echo "*** Is the directory with i386-elf-gcc in your PATH?" 1&gt;&amp;2; \</span></span><br><span class="line"><span class="variable">        echo "*** If your i386-elf toolchain is installed with a command" 1&gt;&amp;2; \</span></span><br><span class="line"><span class="variable">        echo "*** prefix other than 'i386-elf-', set your GCCPREFIX" 1&gt;&amp;2; \</span></span><br><span class="line"><span class="variable">        echo "*** environment variable to that prefix <span class="built_in">and</span> run 'make' again." 1&gt;&amp;2; \</span></span><br><span class="line"><span class="variable">        echo "*** To turn off this <span class="built_in">error</span>, run 'gmake GCCPREFIX= ...'." 1&gt;&amp;2; \</span></span><br><span class="line"><span class="variable">        echo "***" 1&gt;&amp;2; exit 1; fi)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># try to infer the correct QEMU</span></span><br><span class="line"><span class="keyword">ifndef</span> QEMU</span><br><span class="line">QEMU := <span class="variable">$(<span class="built_in">shell</span> <span class="built_in">if</span> which qemu-system-i386 &gt; /dev/null; \</span></span><br><span class="line"><span class="variable">        then echo 'qemu-system-i386'; exit; \</span></span><br><span class="line"><span class="variable">        elif which i386-elf-qemu &gt; /dev/null; \</span></span><br><span class="line"><span class="variable">        then echo 'i386-elf-qemu'; exit; \</span></span><br><span class="line"><span class="variable">        elif which qemu &gt; /dev/null; \</span></span><br><span class="line"><span class="variable">        then echo 'qemu'; exit; \</span></span><br><span class="line"><span class="variable">        else \</span></span><br><span class="line"><span class="variable">        echo "***" 1&gt;&amp;2; \</span></span><br><span class="line"><span class="variable">        echo "*** Error: Couldn't find a working QEMU executable." 1&gt;&amp;2; \</span></span><br><span class="line"><span class="variable">        echo "*** Is the directory containing the qemu binary in your PATH" 1&gt;&amp;2; \</span></span><br><span class="line"><span class="variable">        echo "***" 1&gt;&amp;2; exit 1; fi)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># eliminate default suffix rules</span></span><br><span class="line"><span class="section">.SUFFIXES: .c .S .h</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># delete target files if there is an error (or make is interrupted)</span></span><br><span class="line"><span class="section">.DELETE_ON_ERROR:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># define compiler and flags</span></span><br><span class="line"><span class="keyword">ifndef</span>  USELLVM</span><br><span class="line">HOSTCC          := gcc</span><br><span class="line">HOSTCFLAGS      := -g -Wall -O2</span><br><span class="line">CC              := <span class="variable">$(GCCPREFIX)</span>gcc</span><br><span class="line">CFLAGS  := -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc <span class="variable">$(DEFS)</span></span><br><span class="line">CFLAGS  += <span class="variable">$(<span class="built_in">shell</span> <span class="variable">$(CC)</span> -fno-stack-protector -E -x c /dev/null &gt;/dev/null 2&gt;&amp;1 &amp;&amp; echo -fno-stack-protector)</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">HOSTCC          := clang</span><br><span class="line">HOSTCFLAGS      := -g -Wall -O2</span><br><span class="line">CC              := clang</span><br><span class="line">CFLAGS  := -fno-builtin -Wall -g -m32 -mno-sse -nostdinc <span class="variable">$(DEFS)</span></span><br><span class="line">CFLAGS  += <span class="variable">$(<span class="built_in">shell</span> <span class="variable">$(CC)</span> -fno-stack-protector -E -x c /dev/null &gt;/dev/null 2&gt;&amp;1 &amp;&amp; echo -fno-stack-protector)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line">CTYPE   := c S</span><br><span class="line"></span><br><span class="line">LD      := <span class="variable">$(GCCPREFIX)</span>ld</span><br><span class="line">LDFLAGS := -m <span class="variable">$(<span class="built_in">shell</span> <span class="variable">$(LD)</span> -V | grep elf_i386 2&gt;/dev/null)</span></span><br><span class="line">LDFLAGS += -nostdlib</span><br><span class="line"></span><br><span class="line">OBJCOPY := <span class="variable">$(GCCPREFIX)</span>objcopy</span><br><span class="line">OBJDUMP := <span class="variable">$(GCCPREFIX)</span>objdump</span><br><span class="line"></span><br><span class="line">COPY    := cp</span><br><span class="line">MKDIR   := mkdir -p</span><br><span class="line">MV              := mv</span><br><span class="line">RM              := rm -f</span><br><span class="line">AWK             := awk</span><br><span class="line">SED             := sed</span><br><span class="line">SH              := sh</span><br><span class="line">TR              := tr</span><br><span class="line">TOUCH   := touch -c</span><br><span class="line"></span><br><span class="line">OBJDIR  := obj</span><br><span class="line">BINDIR  := bin</span><br><span class="line"></span><br><span class="line">ALLOBJS :=</span><br><span class="line">ALLDEPS :=</span><br><span class="line">TARGETS :=</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> tools/function.mk</span><br><span class="line"></span><br><span class="line">listf_cc = <span class="variable">$(<span class="built_in">call</span> listf,$(1)</span>,<span class="variable">$(CTYPE)</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># for cc</span></span><br><span class="line">add_files_cc = <span class="variable">$(<span class="built_in">call</span> add_files,$(1)</span>,<span class="variable">$(CC)</span>,<span class="variable">$(CFLAGS)</span> $(3),$(2),$(4))</span><br><span class="line">create_target_cc = <span class="variable">$(<span class="built_in">call</span> create_target,$(1)</span>,$(2),$(3),<span class="variable">$(CC)</span>,<span class="variable">$(CFLAGS)</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># for hostcc</span></span><br><span class="line">add_files_host = <span class="variable">$(<span class="built_in">call</span> add_files,$(1)</span>,<span class="variable">$(HOSTCC)</span>,<span class="variable">$(HOSTCFLAGS)</span>,$(2),$(3))</span><br><span class="line">create_target_host = <span class="variable">$(<span class="built_in">call</span> create_target,$(1)</span>,$(2),$(3),<span class="variable">$(HOSTCC)</span>,<span class="variable">$(HOSTCFLAGS)</span>)</span><br><span class="line"></span><br><span class="line">cgtype = <span class="variable">$(<span class="built_in">patsubst</span> %.$(2)</span>,%.$(3),$(1))</span><br><span class="line">objfile = <span class="variable">$(<span class="built_in">call</span> toobj,$(1)</span>)</span><br><span class="line">asmfile = <span class="variable">$(<span class="built_in">call</span> cgtype,$(<span class="built_in">call</span> toobj,$(1)</span>),o,asm)</span><br><span class="line">outfile = <span class="variable">$(<span class="built_in">call</span> cgtype,$(<span class="built_in">call</span> toobj,$(1)</span>),o,out)</span><br><span class="line">symfile = <span class="variable">$(<span class="built_in">call</span> cgtype,$(<span class="built_in">call</span> toobj,$(1)</span>),o,sym)</span><br><span class="line"></span><br><span class="line"><span class="comment"># for match pattern</span></span><br><span class="line">match = <span class="variable">$(<span class="built_in">shell</span> echo $(2)</span> | <span class="variable">$(AWK)</span> '&#123;for(i=1;i&lt;=NF;i++)&#123;if(match(<span class="string">"$(1)"</span>,<span class="string">"^"</span>$<span class="variable">$(i)</span><span class="string">"$$"</span>))&#123;exit 1;&#125;&#125;&#125;'; echo $<span class="variable">$?</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span></span><br><span class="line"><span class="comment"># include kernel/user</span></span><br><span class="line"></span><br><span class="line">INCLUDE += libs/</span><br><span class="line"></span><br><span class="line">CFLAGS  += <span class="variable">$(<span class="built_in">addprefix</span> -I,<span class="variable">$(INCLUDE)</span>)</span></span><br><span class="line"></span><br><span class="line">LIBDIR  += libs</span><br><span class="line"></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> add_files_cc,$(<span class="built_in">call</span> listf_cc,<span class="variable">$(LIBDIR)</span>)</span>,libs,)</span><br><span class="line"></span><br><span class="line"><span class="comment"># -------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># kernel</span></span><br><span class="line"></span><br><span class="line">KINCLUDE        += kern/debug/ \</span><br><span class="line">                           kern/driver/ \</span><br><span class="line">                           kern/trap/ \</span><br><span class="line">                           kern/mm/</span><br><span class="line"></span><br><span class="line">KSRCDIR         += kern/init \</span><br><span class="line">                           kern/libs \</span><br><span class="line">                           kern/debug \</span><br><span class="line">                           kern/driver \</span><br><span class="line">                           kern/trap \</span><br><span class="line">                           kern/mm</span><br><span class="line"></span><br><span class="line">KCFLAGS         += <span class="variable">$(<span class="built_in">addprefix</span> -I,<span class="variable">$(KINCLUDE)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> add_files_cc,$(<span class="built_in">call</span> listf_cc,<span class="variable">$(KSRCDIR)</span>)</span>,kernel,<span class="variable">$(KCFLAGS)</span>)</span><br><span class="line"></span><br><span class="line">KOBJS   = <span class="variable">$(<span class="built_in">call</span> read_packet,kernel libs)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create kernel target</span></span><br><span class="line">kernel = <span class="variable">$(<span class="built_in">call</span> totarget,kernel)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(kernel)</span>: tools/kernel.ld</span><br><span class="line"></span><br><span class="line"><span class="variable">$(kernel)</span>: <span class="variable">$(KOBJS)</span></span><br><span class="line">        @echo + ld <span class="variable">$@</span></span><br><span class="line">        <span class="variable">$(V)</span><span class="variable">$(LD)</span> <span class="variable">$(LDFLAGS)</span> -T tools/kernel.ld -o <span class="variable">$@</span> <span class="variable">$(KOBJS)</span></span><br><span class="line">        @<span class="variable">$(OBJDUMP)</span> -S <span class="variable">$@</span> &gt; <span class="variable">$(<span class="built_in">call</span> asmfile,kernel)</span></span><br><span class="line">        @<span class="variable">$(OBJDUMP)</span> -t <span class="variable">$@</span> | <span class="variable">$(SED)</span> '1,/SYMBOL TABLE/d; s/ .* / /; /^$$/d' &gt; <span class="variable">$(<span class="built_in">call</span> symfile,kernel)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> create_target,kernel)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create bootblock</span></span><br><span class="line">bootfiles = <span class="variable">$(<span class="built_in">call</span> listf_cc,boot)</span></span><br><span class="line"><span class="variable">$(<span class="built_in">foreach</span> f,<span class="variable">$(bootfiles)</span>,$(<span class="built_in">call</span> cc_compile,<span class="variable">$(f)</span>,<span class="variable">$(CC)</span>,<span class="variable">$(CFLAGS)</span> -Os -nostdinc)</span>)</span><br><span class="line"></span><br><span class="line">bootblock = <span class="variable">$(<span class="built_in">call</span> totarget,bootblock)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(bootblock)</span>: <span class="variable">$(<span class="built_in">call</span> toobj,<span class="variable">$(bootfiles)</span>)</span> | <span class="variable">$(<span class="built_in">call</span> totarget,sign)</span></span><br><span class="line">        @echo + ld <span class="variable">$@</span></span><br><span class="line">        <span class="variable">$(V)</span><span class="variable">$(LD)</span> <span class="variable">$(LDFLAGS)</span> -N -e start -Ttext 0x7C00 <span class="variable">$^</span> -o <span class="variable">$(<span class="built_in">call</span> toobj,bootblock)</span></span><br><span class="line">        @<span class="variable">$(OBJDUMP)</span> -S <span class="variable">$(<span class="built_in">call</span> objfile,bootblock)</span> &gt; <span class="variable">$(<span class="built_in">call</span> asmfile,bootblock)</span></span><br><span class="line">        @<span class="variable">$(OBJCOPY)</span> -S -O binary <span class="variable">$(<span class="built_in">call</span> objfile,bootblock)</span> <span class="variable">$(<span class="built_in">call</span> outfile,bootblock)</span></span><br><span class="line">        @<span class="variable">$(<span class="built_in">call</span> totarget,sign)</span> <span class="variable">$(<span class="built_in">call</span> outfile,bootblock)</span> <span class="variable">$(bootblock)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> create_target,bootblock)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create 'sign' tools</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> add_files_host,tools/sign.c,sign,sign)</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> create_target_host,sign,sign)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create ucore.img</span></span><br><span class="line">UCOREIMG        := <span class="variable">$(<span class="built_in">call</span> totarget,ucore.img)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(UCOREIMG)</span>: <span class="variable">$(kernel)</span> <span class="variable">$(bootblock)</span></span><br><span class="line">        <span class="variable">$(V)</span>dd if=/dev/zero of=<span class="variable">$@</span> count=10000</span><br><span class="line">        <span class="variable">$(V)</span>dd if=<span class="variable">$(bootblock)</span> of=<span class="variable">$@</span> conv=notrunc</span><br><span class="line">        <span class="variable">$(V)</span>dd if=<span class="variable">$(kernel)</span> of=<span class="variable">$@</span> seek=1 conv=notrunc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> create_target,ucore.img)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> finish_all)</span></span><br><span class="line"></span><br><span class="line">IGNORE_ALLDEPS  = clean \</span><br><span class="line">                                  dist-clean \</span><br><span class="line">                                  grade \</span><br><span class="line">                                  touch \</span><br><span class="line">                                  print-.+ \</span><br><span class="line">                                  handin</span><br><span class="line"></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">call</span> match,<span class="variable">$(MAKECMDGOALS)</span>,<span class="variable">$(IGNORE_ALLDEPS)</span>)</span>,0)</span><br><span class="line"><span class="keyword">-include</span> <span class="variable">$(ALLDEPS)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># files for grade script</span></span><br><span class="line"></span><br><span class="line"><span class="section">TARGETS: <span class="variable">$(TARGETS)</span></span></span><br><span class="line"></span><br><span class="line">.DEFAULT_GOAL := TARGETS</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: qemu qemu-nox debug debug-nox</span></span><br><span class="line"><span class="section">qemu-mon: <span class="variable">$(UCOREIMG)</span></span></span><br><span class="line">        <span class="variable">$(V)</span><span class="variable">$(QEMU)</span>  -no-reboot -monitor stdio -hda <span class="variable">$&lt;</span> -serial null</span><br><span class="line"><span class="section">qemu: <span class="variable">$(UCOREIMG)</span></span></span><br><span class="line">        <span class="variable">$(V)</span><span class="variable">$(QEMU)</span> -no-reboot -parallel stdio -hda <span class="variable">$&lt;</span> -serial null</span><br><span class="line"><span class="section">log: <span class="variable">$(UCOREIMG)</span></span></span><br><span class="line">        <span class="variable">$(V)</span><span class="variable">$(QEMU)</span> -no-reboot -d int,cpu_reset  -D q.log -parallel stdio -hda <span class="variable">$&lt;</span> -serial null</span><br><span class="line"><span class="section">qemu-nox: <span class="variable">$(UCOREIMG)</span></span></span><br><span class="line">        <span class="variable">$(V)</span><span class="variable">$(QEMU)</span>   -no-reboot -serial mon:stdio -hda <span class="variable">$&lt;</span> -nographic</span><br><span class="line">TERMINAL        :=gnome-terminal</span><br><span class="line"><span class="section">debug: <span class="variable">$(UCOREIMG)</span></span></span><br><span class="line">        <span class="variable">$(V)</span><span class="variable">$(QEMU)</span> -S -s -parallel stdio -hda <span class="variable">$&lt;</span> -serial null &amp;</span><br><span class="line">        <span class="variable">$(V)</span>sleep 2</span><br><span class="line">        <span class="variable">$(V)</span><span class="variable">$(TERMINAL)</span> -e <span class="string">"gdb -q -tui -x tools/gdbinit"</span></span><br><span class="line"></span><br><span class="line"><span class="section">debug-nox: <span class="variable">$(UCOREIMG)</span></span></span><br><span class="line">        <span class="variable">$(V)</span><span class="variable">$(QEMU)</span> -S -s -serial mon:stdio -hda <span class="variable">$&lt;</span> -nographic &amp;</span><br><span class="line">        <span class="variable">$(V)</span>sleep 2</span><br><span class="line">        <span class="variable">$(V)</span><span class="variable">$(TERMINAL)</span> -e <span class="string">"gdb -q -x tools/gdbinit"</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: grade touch</span></span><br><span class="line"></span><br><span class="line">GRADE_GDB_IN    := .gdb.in</span><br><span class="line">GRADE_QEMU_OUT  := .qemu.out</span><br><span class="line">HANDIN                  := proj<span class="variable">$(PROJ)</span>-handin.tar.gz</span><br><span class="line"></span><br><span class="line">TOUCH_FILES             := kern/trap/trap.c</span><br><span class="line"></span><br><span class="line">MAKEOPTS                := --quiet --no-print-directory</span><br><span class="line"></span><br><span class="line"><span class="section">grade:</span></span><br><span class="line">        <span class="variable">$(V)</span><span class="variable">$(MAKE)</span> <span class="variable">$(MAKEOPTS)</span> clean</span><br><span class="line">        <span class="variable">$(V)</span><span class="variable">$(SH)</span> tools/grade.sh</span><br><span class="line"></span><br><span class="line"><span class="section">touch:</span></span><br><span class="line">        <span class="variable">$(V)</span><span class="variable">$(<span class="built_in">foreach</span> f,<span class="variable">$(TOUCH_FILES)</span>,<span class="variable">$(TOUCH)</span> <span class="variable">$(f)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">print-%:</span></span><br><span class="line">        @echo $(<span class="variable">$(<span class="built_in">shell</span> echo $(<span class="built_in">patsubst</span> print-%,%,<span class="variable">$@</span>)</span> | <span class="variable">$(TR)</span> [a-z] [A-Z]))</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: clean dist-clean handin packall tags</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">        <span class="variable">$(V)</span><span class="variable">$(RM)</span> <span class="variable">$(GRADE_GDB_IN)</span> <span class="variable">$(GRADE_QEMU_OUT)</span> cscope* tags</span><br><span class="line">        -<span class="variable">$(RM)</span> -r <span class="variable">$(OBJDIR)</span> <span class="variable">$(BINDIR)</span></span><br><span class="line"></span><br><span class="line"><span class="section">dist-clean: clean</span></span><br><span class="line">        -<span class="variable">$(RM)</span> <span class="variable">$(HANDIN)</span></span><br><span class="line"></span><br><span class="line"><span class="section">handin: packall</span></span><br><span class="line">        @echo Please visit http://learn.tsinghua.edu.cn and upload <span class="variable">$(HANDIN)</span>. Thanks!</span><br><span class="line"></span><br><span class="line"><span class="section">packall: clean</span></span><br><span class="line">        @<span class="variable">$(RM)</span> -f <span class="variable">$(HANDIN)</span></span><br><span class="line">        @tar -czf <span class="variable">$(HANDIN)</span> `find . -type f -o -type d | grep -v '^\.*$$' | grep -vF '<span class="variable">$(HANDIN)</span>'`</span><br><span class="line"></span><br><span class="line"><span class="section">tags:</span></span><br><span class="line">        @echo TAGS ALL</span><br><span class="line">        <span class="variable">$(V)</span>rm -f cscope.files cscope.in.out cscope.out cscope.po.out tags</span><br><span class="line">        <span class="variable">$(V)</span>find . -type f -name <span class="string">"*.[chS]"</span> &gt;cscope.files</span><br><span class="line">        <span class="variable">$(V)</span>cscope -bq</span><br><span class="line">        <span class="variable">$(V)</span>ctags -L cscope.files</span><br></pre></td></tr></table></figure></div>
<p>删除<code>bin</code>和<code>obj</code>文件夹 ，或者用<code>make clean</code>清除编译文件，运行下面命令得到<code>make</code>的详细信息</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="BASH"><figure class="iseeu highlight /bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make <span class="string">"V="</span></span><br></pre></td></tr></table></figure></div>
   <div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="BASH"><figure class="iseeu highlight /bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">   [~/Desktop/ucore_lab/labcodes/lab1]</span><br><span class="line">moocos-&gt; ls</span><br><span class="line">   bin  boot  kern  libs  Makefile  obj  q.log  tools</span><br><span class="line">   [~/Desktop/ucore_lab/labcodes/lab1]</span><br><span class="line">   moocos-&gt; rm -rf bin/ obj/</span><br><span class="line">   [~/Desktop/ucore_lab/labcodes/lab1]</span><br><span class="line">   moocos-&gt; ls</span><br><span class="line">   boot  kern  libs  Makefile  q.log  tools</span><br><span class="line">   [~/Desktop/ucore_lab/labcodes/lab1]</span><br><span class="line">   moocos-&gt; make <span class="string">"V="</span></span><br><span class="line">   + cc kern/init/init.c</span><br><span class="line">   gcc -Ikern/init/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc  -fno-stack-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/<span class="built_in">trap</span>/ -Ikern/mm/ -c kern/init/init.c -o obj/kern/init/init.o</span><br><span class="line">   kern/init/init.c:95:1: warning: ‘lab1_switch_test’ defined but not used [-Wunused-function]</span><br><span class="line">    lab1_switch_test(void) &#123;</span><br><span class="line">    ^</span><br><span class="line">   + cc kern/libs/readline.c</span><br><span class="line">   gcc -Ikern/libs/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc  -fno-stack-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/<span class="built_in">trap</span>/ -Ikern/mm/ -c kern/libs/readline.c -o obj/kern/libs/readline.o</span><br><span class="line">   + cc kern/libs/stdio.c</span><br><span class="line">   gcc -Ikern/libs/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc  -fno-stack-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/<span class="built_in">trap</span>/ -Ikern/mm/ -c kern/libs/stdio.c -o obj/kern/libs/stdio.o</span><br><span class="line">   + cc kern/debug/kdebug.c</span><br><span class="line">   gcc -Ikern/debug/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc  -fno-stack-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/<span class="built_in">trap</span>/ -Ikern/mm/ -c kern/debug/kdebug.c -o obj/kern/debug/kdebug.o</span><br><span class="line">   kern/debug/kdebug.c:251:1: warning: ‘read_eip’ defined but not used [-Wunused-function]</span><br><span class="line">    read_eip(void) &#123;</span><br><span class="line">    ^</span><br><span class="line">   + cc kern/debug/kmonitor.c</span><br><span class="line">   gcc -Ikern/debug/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc  -fno-stack-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/<span class="built_in">trap</span>/ -Ikern/mm/ -c kern/debug/kmonitor.c -o obj/kern/debug/kmonitor.o</span><br><span class="line">   + cc kern/debug/panic.c</span><br><span class="line">   gcc -Ikern/debug/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc  -fno-stack-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/<span class="built_in">trap</span>/ -Ikern/mm/ -c kern/debug/panic.c -o obj/kern/debug/panic.o</span><br><span class="line">   + cc kern/driver/clock.c</span><br><span class="line">   gcc -Ikern/driver/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc  -fno-stack-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/<span class="built_in">trap</span>/ -Ikern/mm/ -c kern/driver/clock.c -o obj/kern/driver/clock.o</span><br><span class="line">   + cc kern/driver/console.c</span><br><span class="line">   gcc -Ikern/driver/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc  -fno-stack-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/<span class="built_in">trap</span>/ -Ikern/mm/ -c kern/driver/console.c -o obj/kern/driver/console.o</span><br><span class="line">   + cc kern/driver/intr.c</span><br><span class="line">   gcc -Ikern/driver/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc  -fno-stack-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/<span class="built_in">trap</span>/ -Ikern/mm/ -c kern/driver/intr.c -o obj/kern/driver/intr.o</span><br><span class="line">   + cc kern/driver/picirq.c</span><br><span class="line">   gcc -Ikern/driver/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc  -fno-stack-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/<span class="built_in">trap</span>/ -Ikern/mm/ -c kern/driver/picirq.c -o obj/kern/driver/picirq.o</span><br><span class="line">   + cc kern/<span class="built_in">trap</span>/trap.c</span><br><span class="line">   gcc -Ikern/<span class="built_in">trap</span>/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc  -fno-stack-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/<span class="built_in">trap</span>/ -Ikern/mm/ -c kern/<span class="built_in">trap</span>/trap.c -o obj/kern/<span class="built_in">trap</span>/trap.o</span><br><span class="line">   kern/<span class="built_in">trap</span>/trap.c:14:13: warning: ‘print_ticks’ defined but not used [-Wunused-function]</span><br><span class="line">    static void <span class="function"><span class="title">print_ticks</span></span>() &#123;</span><br><span class="line">                ^</span><br><span class="line">   kern/<span class="built_in">trap</span>/trap.c:30:26: warning: ‘idt_pd’ defined but not used [-Wunused-variable]</span><br><span class="line">    static struct pseudodesc idt_pd = &#123;</span><br><span class="line">                             ^</span><br><span class="line">   + cc kern/<span class="built_in">trap</span>/trapentry.S</span><br><span class="line">   gcc -Ikern/<span class="built_in">trap</span>/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc  -fno-stack-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/<span class="built_in">trap</span>/ -Ikern/mm/ -c kern/<span class="built_in">trap</span>/trapentry.S -o obj/kern/<span class="built_in">trap</span>/trapentry.o</span><br><span class="line">   + cc kern/<span class="built_in">trap</span>/vectors.S</span><br><span class="line">   gcc -Ikern/<span class="built_in">trap</span>/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc  -fno-stack-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/<span class="built_in">trap</span>/ -Ikern/mm/ -c kern/<span class="built_in">trap</span>/vectors.S -o obj/kern/<span class="built_in">trap</span>/vectors.o</span><br><span class="line">   + cc kern/mm/pmm.c</span><br><span class="line">   gcc -Ikern/mm/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc  -fno-stack-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/<span class="built_in">trap</span>/ -Ikern/mm/ -c kern/mm/pmm.c -o obj/kern/mm/pmm.o</span><br><span class="line">   + cc libs/printfmt.c</span><br><span class="line">   gcc -Ilibs/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc  -fno-stack-protector -Ilibs/  -c libs/printfmt.c -o obj/libs/printfmt.o</span><br><span class="line">   + cc libs/string.c</span><br><span class="line">   gcc -Ilibs/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc  -fno-stack-protector -Ilibs/  -c libs/string.c -o obj/libs/string.o</span><br><span class="line">   + ld bin/kernel</span><br><span class="line">   ld -m    elf_i386 -nostdlib -T tools/kernel.ld -o bin/kernel  obj/kern/init/init.o obj/kern/libs/readline.o obj/kern/libs/stdio.o obj/kern/debug/kdebug.o obj/kern/debug/kmonitor.o obj/kern/debug/panic.o obj/kern/driver/clock.o obj/kern/driver/console.o obj/kern/driver/intr.o obj/kern/driver/picirq.o obj/kern/<span class="built_in">trap</span>/trap.o obj/kern/<span class="built_in">trap</span>/trapentry.o obj/kern/<span class="built_in">trap</span>/vectors.o obj/kern/mm/pmm.o  obj/libs/printfmt.o obj/libs/string.o</span><br><span class="line">   + cc boot/bootasm.S</span><br><span class="line">   gcc -Iboot/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc  -fno-stack-protector -Ilibs/ -Os -nostdinc -c boot/bootasm.S -o obj/boot/bootasm.o</span><br><span class="line">   + cc boot/bootmain.c</span><br><span class="line">   gcc -Iboot/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc  -fno-stack-protector -Ilibs/ -Os -nostdinc -c boot/bootmain.c -o obj/boot/bootmain.o</span><br><span class="line">   + cc tools/sign.c</span><br><span class="line">   gcc -Itools/ -g -Wall -O2 -c tools/sign.c -o obj/sign/tools/sign.o</span><br><span class="line">   gcc -g -Wall -O2 obj/sign/tools/sign.o -o bin/sign</span><br><span class="line">   + ld bin/bootblock</span><br><span class="line">   ld -m    elf_i386 -nostdlib -N -e start -Ttext 0x7C00 obj/boot/bootasm.o obj/boot/bootmain.o -o obj/bootblock.o</span><br><span class="line">   <span class="string">'obj/bootblock.out'</span> size: 472 bytes</span><br><span class="line">   build 512 bytes boot sector: <span class="string">'bin/bootblock'</span> success!</span><br><span class="line">   dd <span class="keyword">if</span>=/dev/zero of=bin/ucore.img count=10000</span><br><span class="line">   10000+0 records <span class="keyword">in</span></span><br><span class="line">   10000+0 records out</span><br><span class="line">   5120000 bytes (5.1 MB) copied, 0.0160073 s, 320 MB/s</span><br><span class="line">   dd <span class="keyword">if</span>=bin/bootblock of=bin/ucore.img conv=notrunc</span><br><span class="line">   1+0 records <span class="keyword">in</span></span><br><span class="line">   1+0 records out</span><br><span class="line">   512 bytes (512 B) copied, 0.000253753 s, 2.0 MB/s</span><br><span class="line">   dd <span class="keyword">if</span>=bin/kernel of=bin/ucore.img seek=1 conv=notrunc</span><br><span class="line">   138+1 records <span class="keyword">in</span></span><br><span class="line">   138+1 records out</span><br><span class="line">   70775 bytes (71 kB) copied, 0.000466247 s, 152 MB/s</span><br><span class="line">   [~/Desktop/ucore_lab/labcodes/lab1]</span><br><span class="line">   moocos-&gt; ls</span><br><span class="line">   bin  boot  kern  libs  Makefile  obj  q.log  tools</span><br></pre></td></tr></table></figure></div>
<p>可以看到，ucore.img 通过make的最后三个dd命令生成：</p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/uyia5N9.png" alt="image-20200307223319152"></p>
<p>对应Makefile文件命令为</p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/07JYPSI.png" alt="image-20200307225339592"></p>
<p>第一个dd表示在<code>bin</code>文件夹下创建<code>ucore.img</code>，其大小为10000个块。</p>
<p>第二个dd表示将<code>/bin/bootblock</code>的内容复制到第一个块，其中<code>noerror</code>选项意味着如果发生错误，程序也将继续运行。</p>
<p>第三个dd表示从第二个块开始复制<code>/bin/kernel</code>中的内容，<code>seek</code>表示跳过第一个块开始写。</p>
<p>因此首先要先生成<code>bootlock</code>和<code>kernel</code>文件</p>
<p>kernel生成：</p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/WLal3yd.png" alt="image-20200307225636354"></p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/G1nFH56.png" alt="image-20200307230243874"></p>
<p>对应Makefile文件命令为</p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/x9DbijL.png" alt="image-20200307234603343"></p>
<blockquote>
<p>gcc命令参数解释<br>
-I 添加搜索头文件的路径<br>
-fno-builtin 不进行builtin函数的优化<br>
-Wall 编译后显示所有警告<br>
-ggdb 生成可供gdb使用的调试信息<br>
-m32 生成适用于32位环境的代码<br>
-gstabs 生成stabs格式的调试信息<br>
-nostdinc 不使用标准库<br>
-fno-stack-protector 不生成用于检测缓冲区溢出的代码<br>
-Os 为减小代码大小而进行优化<br>
-c只激活预处理,编译,和汇编,也就是他只把程序做成obj文件</p>
</blockquote>
<p>由图可知，要生成文件<code>kernel</code>，需要将<code>obj/kern</code>文件夹下的所有<code>.c</code>文件编译生成<code>.o</code>文件,有如下文件：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">obj&#x2F;kern&#x2F;init&#x2F;init.o </span><br><span class="line">obj&#x2F;kern&#x2F;libs&#x2F;readline.o </span><br><span class="line">obj&#x2F;kern&#x2F;libs&#x2F;stdio.o </span><br><span class="line">obj&#x2F;kern&#x2F;debug&#x2F;kdebug.o </span><br><span class="line">obj&#x2F;kern&#x2F;debug&#x2F;kmonitor.o </span><br><span class="line">obj&#x2F;kern&#x2F;debug&#x2F;panic.o </span><br><span class="line">obj&#x2F;kern&#x2F;driver&#x2F;clock.o </span><br><span class="line">obj&#x2F;kern&#x2F;driver&#x2F;console.o </span><br><span class="line">obj&#x2F;kern&#x2F;driver&#x2F;intr.o </span><br><span class="line">obj&#x2F;kern&#x2F;driver&#x2F;picirq.o </span><br><span class="line">obj&#x2F;kern&#x2F;trap&#x2F;trap.o </span><br><span class="line">obj&#x2F;kern&#x2F;trap&#x2F;trapentry.o </span><br><span class="line">obj&#x2F;kern&#x2F;trap&#x2F;vectors.o </span><br><span class="line">obj&#x2F;kern&#x2F;mm&#x2F;pmm.o  </span><br><span class="line">obj&#x2F;libs&#x2F;printfmt.o </span><br><span class="line">obj&#x2F;libs&#x2F;string.o</span><br></pre></td></tr></table></figure></div>
<p>然后用<code>ld</code>命令将这些<code>.o</code>文件生成一个可执行文件</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="BASH"><figure class="iseeu highlight /bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">   + ld bin/bootblock</span><br><span class="line">ld -m    elf_i386 -nostdlib -T tools/kernel.ld -o bin/kernel  obj/kern/init/init.o obj/kern/libs/readline.o obj/kern/libs/stdio.o obj/kern/debug/kdebug.o obj/kern/debug/kmonitor.o obj/kern/debug/panic.o obj/kern/driver/clock.o obj/kern/driver/console.o obj/kern/driver/intr.o obj/kern/driver/picirq.o obj/kern/<span class="built_in">trap</span>/trap.o obj/kern/<span class="built_in">trap</span>/trapentry.o obj/kern/<span class="built_in">trap</span>/vectors.o obj/kern/mm/pmm.o  obj/libs/printfmt.o obj/libs/string.o</span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>ld命令参数解释<br>
-m    elf_i386表示模拟指定的连接器为<strong>elf_i386</strong><br>
-T tools/kernel.ld表示使用<strong>tools/kernel.ld</strong>作为链接器脚本。此脚本将替换ld的默认链接器脚本（而不是添加到其中）。<br>
-o bin/kernel表示将输出文件在bin文件夹下，文件名为<strong>kernel</strong><br>
后面跟着的<code>.o</code>文件是所要转化的文件</p>
</blockquote>
<p>bootlock生成<br>
<img src="/images/loading.gif" data-original="/posts/335ac3b4/rDceM5H.png" alt="image-20200307234212505"></p>
<p>对应的Makefile命令为</p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/JFXM7Bl.png" alt="image-20200307234724465"></p>
<p>可以看到，要生成bootlock，需要先生成<code>bootams.o, bootmian.c, sign.c</code></p>
<blockquote>
<p>gcc命令参数解释<br>
-I 添加搜索头文件的路径<br>
-fno-builtin 不进行builtin函数的优化<br>
-Wall 编译后显示所有警告<br>
-ggdb 生成可供gdb使用的调试信息<br>
-m32 生成适用于32位环境的代码<br>
-gstabs 生成stabs格式的调试信息<br>
-nostdinc 不使用标准库<br>
-fno-stack-protector 不生成用于检测缓冲区溢出的代码<br>
-Os 为减小代码大小而进行优化<br>
-c只激活预处理,编译,和汇编,也就是他只把程序做成obj文件</p>
</blockquote>
<p>生成bootfile对应的源码由宏定义批量实现</p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/QKWzrdM.png" alt="image-20200308000103617"></p>
<p>生成sign对应的Makefile源码为</p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/IBotCQg.png" alt="image-20200307235431536"></p>
<p>最后用ld命令生成</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="BASH"><figure class="iseeu highlight /bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">   + ld bin/bootblock</span><br><span class="line">ld -m    elf_i386 -nostdlib -N -e start -Ttext 0x7C00 obj/boot/bootasm.o obj/boot/bootmain.o -o obj/bootblock.o</span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>ld命令参数解释<br>
-m    elf_i386表示模拟指定的连接器为<strong>elf_i386</strong><br>
-nostdlib 表示不连接系统标准启动文件和标准库文件，只把指定的文件传递给连接器。这个选项常用于编译内核、bootloader等程序，它们不需要启动文件、标准库文件。<br>
-N 设置代码段和数据段均可读写<br>
-e 指定入口<br>
start 代码段开始于<br>
-Ttext 制定代码段开始位置<br>
-o obj/bootblock.o表示将输出文件在obj文件夹下，文件名为bootblock</p>
</blockquote>
<ol start="2">
<li>
<p>系统认为是符合规范的硬盘主引导扇区的特征是什么？</p>
<p>查看sign.c文件</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="C"><figure class="iseeu highlight /c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">moocos-&gt; ls tools/</span><br><span class="line">function.mk  gdbinit  grade.sh  kernel.ld  sign.c  <span class="built_in">vector</span>.c</span><br><span class="line">[~/Desktop/ucore_lab/labcodes/lab1]</span><br><span class="line">moocos-&gt; cat tools/sign.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[]) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Usage: &lt;input filename&gt; &lt;output filename&gt;\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (stat(argv[<span class="number">1</span>], &amp;st) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error opening file '%s': %s\n"</span>, argv[<span class="number">1</span>], strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"'%s' size: %lld bytes\n"</span>, argv[<span class="number">1</span>], (<span class="keyword">long</span> <span class="keyword">long</span>)st.st_size);</span><br><span class="line">    <span class="keyword">if</span> (st.st_size &gt; <span class="number">510</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%lld &gt;&gt; 510!!\n"</span>, (<span class="keyword">long</span> <span class="keyword">long</span>)st.st_size);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">512</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    FILE *ifp = fopen(argv[<span class="number">1</span>], <span class="string">"rb"</span>);</span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">size</span> = fread(buf, <span class="number">1</span>, st.st_size, ifp);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">size</span> != st.st_size) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"read '%s' error, size is %d.\n"</span>, argv[<span class="number">1</span>], <span class="built_in">size</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(ifp);</span><br><span class="line">    buf[<span class="number">510</span>] = <span class="number">0x55</span>;</span><br><span class="line">    buf[<span class="number">511</span>] = <span class="number">0xAA</span>;</span><br><span class="line">    FILE *ofp = fopen(argv[<span class="number">2</span>], <span class="string">"wb+"</span>);</span><br><span class="line">    <span class="built_in">size</span> = fwrite(buf, <span class="number">1</span>, <span class="number">512</span>, ofp);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">size</span> != <span class="number">512</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"write '%s' error, size is %d.\n"</span>, argv[<span class="number">2</span>], <span class="built_in">size</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(ofp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"build 512 bytes boot sector: '%s' success!\n"</span>, argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>得知一个被系统认为是符合规范的硬盘主引导扇区的特征有以下几点：<br>
- 磁盘主引导扇区只有512字节<br>
- 磁盘最后两个字节为<code>0x55AA</code></p>
</li>
</ol>
<h1 id="练习2使用qemu执行并调试lab1中的软件"><a class="markdownIt-Anchor" href="#练习2使用qemu执行并调试lab1中的软件"></a> 练习2：使用qemu执行并调试lab1中的软件。</h1>
<p>为了熟悉使用qemu和gdb进行的调试工作，我们进行如下的小练习：</p>
<ol>
<li>
<p>从CPU加电后执行的第一条指令开始，单步跟踪BIOS的执行。</p>
</li>
<li>
<p>在初始化位置0x7c00设置实地址断点,测试断点正常。</p>
</li>
<li>
<p>从0x7c00开始跟踪代码运行,将单步跟踪反汇编得到的代码与bootasm.S和 bootblock.asm进行比较。</p>
</li>
<li>
<p>自己找一个bootloader或内核中的代码位置，设置断点并进行测试。</p>
</li>
</ol>
<h2 id="练习21"><a class="markdownIt-Anchor" href="#练习21"></a> 练习2.1</h2>
<p>首先修改文件</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="BASH"><figure class="iseeu highlight /bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">moocos-&gt; vim tools/gdbinit</span><br></pre></td></tr></table></figure></div>
<p>增加set architecture i8086</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">file bin&#x2F;kernel</span><br><span class="line">set architecture i8086 #增添语句</span><br><span class="line">target remote :1234</span><br><span class="line">break kern_init</span><br><span class="line">continue</span><br></pre></td></tr></table></figure></div>
<p>在GUI界面lab1目录下，执行如下语句</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="BASH"><figure class="iseeu highlight /bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make debug</span><br></pre></td></tr></table></figure></div>
<p>ssh环境下执行会报错</p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/3Zx710h.png" alt></p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/1CjGbqJ.png" alt="image-20200308015334271"></p>
<p>之后使用<code>si</code>命令可使BIOS单步执行</p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/iVPwSz3.png" alt="image-20200308015709679"></p>
<p>在gdb中执行x /2i  $pc 来看BIOS的代码</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x &#x2F;2i $pc #显示当前eip处的汇编指令</span><br></pre></td></tr></table></figure></div>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/eeriLFh.png" alt="image-20200308015905107"></p>
<h2 id="练习22"><a class="markdownIt-Anchor" href="#练习22"></a> 练习2.2</h2>
<p>在 tools/gdbinit中加入中断</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">target remote :1234     &#x2F;&#x2F;连接qemu，此时qemu会进入停止状态，听从gdb的命令</span><br><span class="line">set architecture i8086  &#x2F;&#x2F;设置当前调试的CPU是8086</span><br><span class="line">b *0x7c00   &#x2F;&#x2F;在0x7c00处设置断点。此地址是bootloader入口点地址，可看boot&#x2F;bootasm.S的start地址处</span><br><span class="line">c     &#x2F;&#x2F;continue简称，表示继续执行</span><br><span class="line">x&#x2F;10i $pc    &#x2F;&#x2F;显示当前eip处的汇编指令</span><br></pre></td></tr></table></figure></div>
<p>重新<code>make debug</code>得到</p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/iEnaW4q.png" alt="image-20200308022217191"></p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&gt; 0x7c00:      cli    </span><br><span class="line">   0x7c01:      cld  </span><br><span class="line">   0x7c02:      xor    %ax,%ax</span><br><span class="line">   0x7c04:      mov    %ax,%ds</span><br><span class="line">   0x7c06:      mov    %ax,%es</span><br><span class="line">   0x7c08:      mov    %ax,%ss</span><br><span class="line">   0x7c0a:      in     $0x64,%al</span><br><span class="line">   0x7c0c:      test   $0x2,%al</span><br><span class="line">   0x7c0e:      jne    0x7c0a</span><br><span class="line">   0x7c10:      mov    $0xd1,%al</span><br></pre></td></tr></table></figure></div>
<h2 id="练习23"><a class="markdownIt-Anchor" href="#练习23"></a> 练习2.3</h2>
<p>查看bootasm.S</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">moocos-&gt; cat bootasm.S -n</span><br><span class="line">     1  #include &lt;asm.h&gt;</span><br><span class="line">     2</span><br><span class="line">     </span><br><span class="line">     3  # Start the CPU: switch to 32-bit protected mode, jump into C.</span><br><span class="line">     4  # The BIOS loads this code from the first sector of the hard disk into</span><br><span class="line">     5  # memory at physical address 0x7c00 and starts executing in real mode</span><br><span class="line">     6  # with %cs&#x3D;0 %ip&#x3D;7c00.</span><br><span class="line">     7</span><br><span class="line">     8  .set PROT_MODE_CSEG,        0x8                     # kernel code segment selector</span><br><span class="line">     9  .set PROT_MODE_DSEG,        0x10                    # kernel data segment selector</span><br><span class="line">    10  .set CR0_PE_ON,             0x1                     # protected mode enable flag</span><br><span class="line">    11</span><br><span class="line">    12  # start address should be 0:7c00, in real mode, the beginning address of the running bootloader</span><br><span class="line">    13  .globl start</span><br><span class="line">    14  start:</span><br><span class="line">    15  .code16                                             # Assemble for 16-bit mode</span><br><span class="line">    16      cli                                             # Disable interrupts</span><br><span class="line">    17      cld                                             # String operations increment</span><br><span class="line">    18</span><br><span class="line">    19      # Set up the important data segment registers (DS, ES, SS).</span><br><span class="line">    20      xorw %ax, %ax                                   # Segment number zero</span><br><span class="line">    21      movw %ax, %ds                                   # -&gt; Data Segment</span><br><span class="line">    22      movw %ax, %es                                   # -&gt; Extra Segment</span><br><span class="line">    23      movw %ax, %ss                                   # -&gt; Stack Segment</span><br><span class="line">    24</span><br><span class="line">    25      # Enable A20:</span><br><span class="line">    26      #  For backwards compatibility with the earliest PCs, physical</span><br><span class="line">    27      #  address line 20 is tied low, so that addresses higher than</span><br><span class="line">    28      #  1MB wrap around to zero by default. This code undoes this.</span><br><span class="line">    29  seta20.1:</span><br><span class="line">    30      inb $0x64, %al                                  # Wait for not busy(8042 input buffer empty).</span><br><span class="line">    31      testb $0x2, %al</span><br><span class="line">    32      jnz seta20.1</span><br><span class="line">    33</span><br><span class="line">    34      movb $0xd1, %al                                 # 0xd1 -&gt; port 0x64</span><br><span class="line">    35      outb %al, $0x64                                 # 0xd1 means: write data to 8042&#39;s P2 port</span><br><span class="line">    36</span><br><span class="line">    37  seta20.2:</span><br><span class="line">    38      inb $0x64, %al                                  # Wait for not busy(8042 input buffer empty).</span><br><span class="line">    39      testb $0x2, %al</span><br><span class="line">    40      jnz seta20.2</span><br><span class="line">    41</span><br><span class="line">    42      movb $0xdf, %al                                 # 0xdf -&gt; port 0x60</span><br><span class="line">    43      outb %al, $0x60                                 # 0xdf &#x3D; 11011111, means set P2&#39;s A20 bit(the 1 bit) to 1</span><br><span class="line">    44</span><br><span class="line">    45      # Switch from real to protected mode, using a bootstrap GDT</span><br><span class="line">    46      # and segment translation that makes virtual addresses</span><br><span class="line">    47      # identical to physical addresses, so that the</span><br><span class="line">    48      # effective memory map does not change during the switch.</span><br><span class="line">    49      lgdt gdtdesc</span><br><span class="line">    50      movl %cr0, %eax</span><br><span class="line">    51      orl $CR0_PE_ON, %eax</span><br><span class="line">    52      movl %eax, %cr0</span><br><span class="line">    53</span><br><span class="line">    54      # Jump to next instruction, but in 32-bit code segment.</span><br><span class="line">    55      # Switches processor into 32-bit mode.</span><br><span class="line">    56      ljmp $PROT_MODE_CSEG, $protcseg</span><br><span class="line">    57</span><br><span class="line">    58  .code32                                             # Assemble for 32-bit mode</span><br><span class="line">    59  protcseg:</span><br><span class="line">    60      # Set up the protected-mode data segment registers</span><br><span class="line">    61      movw $PROT_MODE_DSEG, %ax                       # Our data segment selector</span><br><span class="line">    62      movw %ax, %ds                                   # -&gt; DS: Data Segment</span><br><span class="line">    63      movw %ax, %es                                   # -&gt; ES: Extra Segment</span><br><span class="line">    64      movw %ax, %fs                                   # -&gt; FS</span><br><span class="line">    65      movw %ax, %gs                                   # -&gt; GS</span><br><span class="line">    66      movw %ax, %ss                                   # -&gt; SS: Stack Segment</span><br><span class="line">    67</span><br><span class="line">    68      # Set up the stack pointer and call into C. The stack region is from 0--start(0x7c00)</span><br><span class="line">    69      movl $0x0, %ebp</span><br><span class="line">    70      movl $start, %esp</span><br><span class="line">    71      call bootmain</span><br><span class="line">    72</span><br><span class="line">    73      # If bootmain returns (it shouldn&#39;t), loop.</span><br><span class="line">    74  spin:</span><br><span class="line">    75      jmp spin</span><br><span class="line">    76</span><br><span class="line">    77  # Bootstrap GDT</span><br><span class="line">    78  .p2align 2                                          # force 4 byte alignment</span><br><span class="line">    79  gdt:</span><br><span class="line">    80      SEG_NULLASM                                     # null seg</span><br><span class="line">    81      SEG_ASM(STA_X|STA_R, 0x0, 0xffffffff)           # code seg for bootloader and kernel</span><br><span class="line">    82      SEG_ASM(STA_W, 0x0, 0xffffffff)                 # data seg for bootloader and kernel</span><br><span class="line">    83</span><br><span class="line">    84  gdtdesc:</span><br><span class="line">    85      .word 0x17                                      # sizeof(gdt) - 1</span><br><span class="line">    86      .long gdt                                       # address gdt</span><br></pre></td></tr></table></figure></div>
<h3 id="bootblockasm的代码"><a class="markdownIt-Anchor" href="#bootblockasm的代码"></a> bootblock.asm的代码</h3>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br></pre></td><td class="code"><pre><span class="line">moocos-&gt; cat .&#x2F;obj&#x2F;bootblock.asm -n</span><br><span class="line">     1</span><br><span class="line">     2  obj&#x2F;bootblock.o:     file format elf32-i386</span><br><span class="line">     3</span><br><span class="line">     4</span><br><span class="line">     5  Disassembly of section .text:</span><br><span class="line">     6</span><br><span class="line">     7  00007c00 &lt;start&gt;:</span><br><span class="line">     8</span><br><span class="line">     9  # start address should be 0:7c00, in real mode, the beginning address of the running bootloader</span><br><span class="line">    10  .globl start</span><br><span class="line">    11  start:</span><br><span class="line">    12  .code16                                             # Assemble for 16-bit mode</span><br><span class="line">    13      cli                                             # Disable interrupts</span><br><span class="line">    14      7c00:       fa                      cli</span><br><span class="line">    15      cld                                             # String operations increment</span><br><span class="line">    16      7c01:       fc                      cld</span><br><span class="line">    17</span><br><span class="line">    18      # Set up the important data segment registers (DS, ES, SS).</span><br><span class="line">    19      xorw %ax, %ax                                   # Segment number zero</span><br><span class="line">    20      7c02:       31 c0                   xor    %eax,%eax</span><br><span class="line">    21      movw %ax, %ds                                   # -&gt; Data Segment</span><br><span class="line">    22      7c04:       8e d8                   mov    %eax,%ds</span><br><span class="line">    23      movw %ax, %es                                   # -&gt; Extra Segment</span><br><span class="line">    24      7c06:       8e c0                   mov    %eax,%es</span><br><span class="line">    25      movw %ax, %ss                                   # -&gt; Stack Segment</span><br><span class="line">    26      7c08:       8e d0                   mov    %eax,%ss</span><br><span class="line">    27</span><br><span class="line">    28  00007c0a &lt;seta20.1&gt;:</span><br><span class="line">    29      # Enable A20:</span><br><span class="line">    30      #  For backwards compatibility with the earliest PCs, physical</span><br><span class="line">    31      #  address line 20 is tied low, so that addresses higher than</span><br><span class="line">    32      #  1MB wrap around to zero by default. This code undoes this.</span><br><span class="line">    33  seta20.1:</span><br><span class="line">    34      inb $0x64, %al                                  # Wait for not busy(8042 input buffer empty).</span><br><span class="line">    35      7c0a:       e4 64                   in     $0x64,%al</span><br><span class="line">    36      testb $0x2, %al</span><br><span class="line">    37      7c0c:       a8 02                   test   $0x2,%al</span><br><span class="line">    38      jnz seta20.1</span><br><span class="line">    39      7c0e:       75 fa                   jne    7c0a &lt;seta20.1&gt;</span><br><span class="line">    40</span><br><span class="line">    41      movb $0xd1, %al                                 # 0xd1 -&gt; port 0x64</span><br><span class="line">    42      7c10:       b0 d1                   mov    $0xd1,%al</span><br><span class="line">    43      outb %al, $0x64                                 # 0xd1 means: write data to 8042&#39;s P2 port</span><br><span class="line">    44      7c12:       e6 64                   out    %al,$0x64</span><br><span class="line">    45</span><br><span class="line">    46  00007c14 &lt;seta20.2&gt;:</span><br><span class="line">    47</span><br><span class="line">    48  seta20.2:</span><br><span class="line">    49      inb $0x64, %al                                  # Wait for not busy(8042 input buffer empty).</span><br><span class="line">    50      7c14:       e4 64                   in     $0x64,%al</span><br><span class="line">    51      testb $0x2, %al</span><br><span class="line">    52      7c16:       a8 02                   test   $0x2,%al</span><br><span class="line">    53      jnz seta20.2</span><br><span class="line">    54      7c18:       75 fa                   jne    7c14 &lt;seta20.2&gt;</span><br><span class="line">    55</span><br><span class="line">    56      movb $0xdf, %al                                 # 0xdf -&gt; port 0x60</span><br><span class="line">    57      7c1a:       b0 df                   mov    $0xdf,%al</span><br><span class="line">    58      outb %al, $0x60                                 # 0xdf &#x3D; 11011111, means set P2&#39;s A20 bit(the 1 bit) to 1</span><br><span class="line">    59      7c1c:       e6 60                   out    %al,$0x60</span><br><span class="line">    60</span><br><span class="line">    61      # Switch from real to protected mode, using a bootstrap GDT</span><br><span class="line">    62      # and segment translation that makes virtual addresses</span><br><span class="line">    63      # identical to physical addresses, so that the</span><br><span class="line">    64      # effective memory map does not change during the switch.</span><br><span class="line">    65      lgdt gdtdesc</span><br><span class="line">    66      7c1e:       0f 01 16                lgdtl  (%esi)</span><br><span class="line">    67      7c21:       6c                      insb   (%dx),%es:(%edi)</span><br><span class="line">    68      7c22:       7c 0f                   jl     7c33 &lt;protcseg+0x1&gt;</span><br><span class="line">    69      movl %cr0, %eax</span><br><span class="line">    70      7c24:       20 c0                   and    %al,%al</span><br><span class="line">    71      orl $CR0_PE_ON, %eax</span><br><span class="line">    72      7c26:       66 83 c8 01             or     $0x1,%ax</span><br><span class="line">    73      movl %eax, %cr0</span><br><span class="line">    74      7c2a:       0f 22 c0                mov    %eax,%cr0</span><br><span class="line">    75</span><br><span class="line">    76      # Jump to next instruction, but in 32-bit code segment.</span><br><span class="line">    77      # Switches processor into 32-bit mode.</span><br><span class="line">    78      ljmp $PROT_MODE_CSEG, $protcseg</span><br><span class="line">    79      7c2d:       ea 32 7c 08 00 66 b8    ljmp   $0xb866,$0x87c32</span><br><span class="line">    80</span><br><span class="line">    81  00007c32 &lt;protcseg&gt;:</span><br><span class="line">    82</span><br><span class="line">    83  .code32                                             # Assemble for 32-bit mode</span><br><span class="line">    84  protcseg:</span><br><span class="line">    85      # Set up the protected-mode data segment registers</span><br><span class="line">    86      movw $PROT_MODE_DSEG, %ax                       # Our data segment selector</span><br><span class="line">    87      7c32:       66 b8 10 00             mov    $0x10,%ax</span><br><span class="line">    88      movw %ax, %ds                                   # -&gt; DS: Data Segment</span><br><span class="line">    89      7c36:       8e d8                   mov    %eax,%ds</span><br><span class="line">    90      movw %ax, %es                                   # -&gt; ES: Extra Segment</span><br><span class="line">    91      7c38:       8e c0                   mov    %eax,%es</span><br><span class="line">    92      movw %ax, %fs                                   # -&gt; FS</span><br><span class="line">    93      7c3a:       8e e0                   mov    %eax,%fs</span><br><span class="line">    94      movw %ax, %gs                                   # -&gt; GS</span><br><span class="line">    95      7c3c:       8e e8                   mov    %eax,%gs</span><br><span class="line">    96      movw %ax, %ss                                   # -&gt; SS: Stack Segment</span><br><span class="line">    97      7c3e:       8e d0                   mov    %eax,%ss</span><br><span class="line">    98</span><br><span class="line">    99      # Set up the stack pointer and call into C. The stack region is from 0--start(0x7c00)</span><br><span class="line">   100      movl $0x0, %ebp</span><br><span class="line">   101      7c40:       bd 00 00 00 00          mov    $0x0,%ebp</span><br><span class="line">   102      movl $start, %esp</span><br><span class="line">   103      7c45:       bc 00 7c 00 00          mov    $0x7c00,%esp</span><br><span class="line">   104      call bootmain</span><br><span class="line">   105      7c4a:       e8 82 00 00 00          call   7cd1 &lt;bootmain&gt;</span><br><span class="line">   106</span><br><span class="line">   107  00007c4f &lt;spin&gt;:</span><br><span class="line">   108</span><br><span class="line">   109      # If bootmain returns (it shouldn&#39;t), loop.</span><br><span class="line">   110  spin:</span><br><span class="line">   111      jmp spin</span><br><span class="line">   112      7c4f:       eb fe                   jmp    7c4f &lt;spin&gt;</span><br><span class="line">   113      7c51:       8d 76 00                lea    0x0(%esi),%esi</span><br><span class="line">   114</span><br><span class="line">   115  00007c54 &lt;gdt&gt;:</span><br><span class="line">   116          ...</span><br><span class="line">   117      7c5c:       ff                      (bad)</span><br><span class="line">   118      7c5d:       ff 00                   incl   (%eax)</span><br><span class="line">   119      7c5f:       00 00                   add    %al,(%eax)</span><br><span class="line">   120      7c61:       9a cf 00 ff ff 00 00    lcall  $0x0,$0xffff00cf</span><br><span class="line">   121      7c68:       00 92 cf 00 17 00       add    %dl,0x1700cf(%edx)</span><br><span class="line">   122</span><br><span class="line">   123  00007c6c &lt;gdtdesc&gt;:</span><br><span class="line">   124      7c6c:       17                      pop    %ss</span><br><span class="line">   125      7c6d:       00 54 7c 00             add    %dl,0x0(%esp,%edi,2)</span><br><span class="line">   126          ...</span><br><span class="line">   127</span><br><span class="line">   128  00007c72 &lt;readsect&gt;:</span><br><span class="line">   129          &#x2F;* do nothing *&#x2F;;</span><br><span class="line">   130  &#125;</span><br><span class="line">   131</span><br><span class="line">   132  &#x2F;* readsect - read a single sector at @secno into @dst *&#x2F;</span><br><span class="line">   133  static void</span><br><span class="line">   134  readsect(void *dst, uint32_t secno) &#123;</span><br><span class="line">   135      7c72:       55                      push   %ebp</span><br><span class="line">   136      7c73:       89 d1                   mov    %edx,%ecx</span><br><span class="line">   137      7c75:       89 e5                   mov    %esp,%ebp</span><br><span class="line">   138  static inline void ltr(uint16_t sel) __attribute__((always_inline));</span><br><span class="line">   139</span><br><span class="line">   140  static inline uint8_t</span><br><span class="line">   141  inb(uint16_t port) &#123;</span><br><span class="line">   142      uint8_t data;</span><br><span class="line">   143      asm volatile (&quot;inb %1, %0&quot; : &quot;&#x3D;a&quot; (data) : &quot;d&quot; (port));</span><br><span class="line">   144      7c77:       ba f7 01 00 00          mov    $0x1f7,%edx</span><br><span class="line">   145      7c7c:       57                      push   %edi</span><br><span class="line">   146      7c7d:       89 c7                   mov    %eax,%edi</span><br><span class="line">   147      7c7f:       ec                      in     (%dx),%al</span><br><span class="line">   148  #define ELFHDR          ((struct elfhdr *)0x10000)      &#x2F;&#x2F; scratch space</span><br><span class="line">   149</span><br><span class="line">   150  &#x2F;* waitdisk - wait for disk ready *&#x2F;</span><br><span class="line">   151  static void</span><br><span class="line">   152  waitdisk(void) &#123;</span><br><span class="line">   153      while ((inb(0x1F7) &amp; 0xC0) !&#x3D; 0x40)</span><br><span class="line">   154      7c80:       83 e0 c0                and    $0xffffffc0,%eax</span><br><span class="line">   155      7c83:       3c 40                   cmp    $0x40,%al</span><br><span class="line">   156      7c85:       75 f8                   jne    7c7f &lt;readsect+0xd&gt;</span><br><span class="line">   157              : &quot;memory&quot;, &quot;cc&quot;);</span><br><span class="line">   158  &#125;</span><br><span class="line">   159</span><br><span class="line">   160  static inline void</span><br><span class="line">   161  outb(uint16_t port, uint8_t data) &#123;</span><br><span class="line">   162      asm volatile (&quot;outb %0, %1&quot; :: &quot;a&quot; (data), &quot;d&quot; (port));</span><br><span class="line">   163      7c87:       ba f2 01 00 00          mov    $0x1f2,%edx</span><br><span class="line">   164      7c8c:       b0 01                   mov    $0x1,%al</span><br><span class="line">   165      7c8e:       ee                      out    %al,(%dx)</span><br><span class="line">   166      7c8f:       0f b6 c1                movzbl %cl,%eax</span><br><span class="line">   167      7c92:       b2 f3                   mov    $0xf3,%dl</span><br><span class="line">   168      7c94:       ee                      out    %al,(%dx)</span><br><span class="line">   169      7c95:       0f b6 c5                movzbl %ch,%eax</span><br><span class="line">   170      7c98:       b2 f4                   mov    $0xf4,%dl</span><br><span class="line">   171      7c9a:       ee                      out    %al,(%dx)</span><br><span class="line">   172      waitdisk();</span><br><span class="line">   173</span><br><span class="line">   174      outb(0x1F2, 1);                         &#x2F;&#x2F; count &#x3D; 1</span><br><span class="line">   175      outb(0x1F3, secno &amp; 0xFF);</span><br><span class="line">   176      outb(0x1F4, (secno &gt;&gt; 8) &amp; 0xFF);</span><br><span class="line">   177      outb(0x1F5, (secno &gt;&gt; 16) &amp; 0xFF);</span><br><span class="line">   178      7c9b:       89 c8                   mov    %ecx,%eax</span><br><span class="line">   179      7c9d:       b2 f5                   mov    $0xf5,%dl</span><br><span class="line">   180      7c9f:       c1 e8 10                shr    $0x10,%eax</span><br><span class="line">   181      7ca2:       0f b6 c0                movzbl %al,%eax</span><br><span class="line">   182      7ca5:       ee                      out    %al,(%dx)</span><br><span class="line">   183      outb(0x1F6, ((secno &gt;&gt; 24) &amp; 0xF) | 0xE0);</span><br><span class="line">   184      7ca6:       c1 e9 18                shr    $0x18,%ecx</span><br><span class="line">   185      7ca9:       b2 f6                   mov    $0xf6,%dl</span><br><span class="line">   186      7cab:       88 c8                   mov    %cl,%al</span><br><span class="line">   187      7cad:       83 e0 0f                and    $0xf,%eax</span><br><span class="line">   188      7cb0:       83 c8 e0                or     $0xffffffe0,%eax</span><br><span class="line">   189      7cb3:       ee                      out    %al,(%dx)</span><br><span class="line">   190      7cb4:       b0 20                   mov    $0x20,%al</span><br><span class="line">   191      7cb6:       b2 f7                   mov    $0xf7,%dl</span><br><span class="line">   192      7cb8:       ee                      out    %al,(%dx)</span><br><span class="line">   193  static inline void ltr(uint16_t sel) __attribute__((always_inline));</span><br><span class="line">   194</span><br><span class="line">   195  static inline uint8_t</span><br><span class="line">   196  inb(uint16_t port) &#123;</span><br><span class="line">   197      uint8_t data;</span><br><span class="line">   198      asm volatile (&quot;inb %1, %0&quot; : &quot;&#x3D;a&quot; (data) : &quot;d&quot; (port));</span><br><span class="line">   199      7cb9:       ec                      in     (%dx),%al</span><br><span class="line">   200  #define ELFHDR          ((struct elfhdr *)0x10000)      &#x2F;&#x2F; scratch space</span><br><span class="line">   201</span><br><span class="line">   202  &#x2F;* waitdisk - wait for disk ready *&#x2F;</span><br><span class="line">   203  static void</span><br><span class="line">   204  waitdisk(void) &#123;</span><br><span class="line">   205      while ((inb(0x1F7) &amp; 0xC0) !&#x3D; 0x40)</span><br><span class="line">   206      7cba:       83 e0 c0                and    $0xffffffc0,%eax</span><br><span class="line">   207      7cbd:       3c 40                   cmp    $0x40,%al</span><br><span class="line">   208      7cbf:       75 f8                   jne    7cb9 &lt;readsect+0x47&gt;</span><br><span class="line">   209      return data;</span><br><span class="line">   210  &#125;</span><br><span class="line">   211</span><br><span class="line">   212  static inline void</span><br><span class="line">   213  insl(uint32_t port, void *addr, int cnt) &#123;</span><br><span class="line">   214      asm volatile (</span><br><span class="line">   215      7cc1:       b9 80 00 00 00          mov    $0x80,%ecx</span><br><span class="line">   216      7cc6:       ba f0 01 00 00          mov    $0x1f0,%edx</span><br><span class="line">   217      7ccb:       fc                      cld</span><br><span class="line">   218      7ccc:       f2 6d                   repnz insl (%dx),%es:(%edi)</span><br><span class="line">   219      &#x2F;&#x2F; wait for disk to be ready</span><br><span class="line">   220      waitdisk();</span><br><span class="line">   221</span><br><span class="line">   222      &#x2F;&#x2F; read a sector</span><br><span class="line">   223      insl(0x1F0, dst, SECTSIZE &#x2F; 4);</span><br><span class="line">   224  &#125;</span><br><span class="line">   225      7cce:       5f                      pop    %edi</span><br><span class="line">   226      7ccf:       5d                      pop    %ebp</span><br><span class="line">   227      7cd0:       c3                      ret</span><br><span class="line">   228</span><br><span class="line">   229  00007cd1 &lt;bootmain&gt;:</span><br><span class="line">   230      &#125;</span><br><span class="line">   231  &#125;</span><br><span class="line">   232</span><br><span class="line">   233  &#x2F;* bootmain - the entry of bootloader *&#x2F;</span><br><span class="line">   234  void</span><br><span class="line">   235  bootmain(void) &#123;</span><br><span class="line">   236      7cd1:       55                      push   %ebp</span><br><span class="line">   237      7cd2:       89 e5                   mov    %esp,%ebp</span><br><span class="line">   238      7cd4:       57                      push   %edi</span><br><span class="line">   239      7cd5:       56                      push   %esi</span><br><span class="line">   240      7cd6:       53                      push   %ebx</span><br><span class="line">   241</span><br><span class="line">   242      &#x2F;&#x2F; round down to sector boundary</span><br><span class="line">   243      va -&#x3D; offset % SECTSIZE;</span><br><span class="line">   244</span><br><span class="line">   245      &#x2F;&#x2F; translate from bytes to sectors; kernel starts at sector 1</span><br><span class="line">   246      uint32_t secno &#x3D; (offset &#x2F; SECTSIZE) + 1;</span><br><span class="line">   247      7cd7:       bb 01 00 00 00          mov    $0x1,%ebx</span><br><span class="line">   248      &#125;</span><br><span class="line">   249  &#125;</span><br><span class="line">   250</span><br><span class="line">   251  &#x2F;* bootmain - the entry of bootloader *&#x2F;</span><br><span class="line">   252  void</span><br><span class="line">   253  bootmain(void) &#123;</span><br><span class="line">   254      7cdc:       83 ec 1c                sub    $0x1c,%esp</span><br><span class="line">   255      7cdf:       8d 43 7f                lea    0x7f(%ebx),%eax</span><br><span class="line">   256</span><br><span class="line">   257      &#x2F;&#x2F; If this is too slow, we could read lots of sectors at a time.</span><br><span class="line">   258      &#x2F;&#x2F; We&#39;d write more to memory than asked, but it doesn&#39;t matter --</span><br><span class="line">   259      &#x2F;&#x2F; we load in increasing order.</span><br><span class="line">   260      for (; va &lt; end_va; va +&#x3D; SECTSIZE, secno ++) &#123;</span><br><span class="line">   261          readsect((void *)va, secno);</span><br><span class="line">   262      7ce2:       89 da                   mov    %ebx,%edx</span><br><span class="line">   263      7ce4:       c1 e0 09                shl    $0x9,%eax</span><br><span class="line">   264      uint32_t secno &#x3D; (offset &#x2F; SECTSIZE) + 1;</span><br><span class="line">   265</span><br><span class="line">   266      &#x2F;&#x2F; If this is too slow, we could read lots of sectors at a time.</span><br><span class="line">   267      &#x2F;&#x2F; We&#39;d write more to memory than asked, but it doesn&#39;t matter --</span><br><span class="line">   268      &#x2F;&#x2F; we load in increasing order.</span><br><span class="line">   269      for (; va &lt; end_va; va +&#x3D; SECTSIZE, secno ++) &#123;</span><br><span class="line">   270      7ce7:       43                      inc    %ebx</span><br><span class="line">   271          readsect((void *)va, secno);</span><br><span class="line">   272      7ce8:       e8 85 ff ff ff          call   7c72 &lt;readsect&gt;</span><br><span class="line">   273      uint32_t secno &#x3D; (offset &#x2F; SECTSIZE) + 1;</span><br><span class="line">   274</span><br><span class="line">   275      &#x2F;&#x2F; If this is too slow, we could read lots of sectors at a time.</span><br><span class="line">   276      &#x2F;&#x2F; We&#39;d write more to memory than asked, but it doesn&#39;t matter --</span><br><span class="line">   277      &#x2F;&#x2F; we load in increasing order.</span><br><span class="line">   278      for (; va &lt; end_va; va +&#x3D; SECTSIZE, secno ++) &#123;</span><br><span class="line">   279      7ced:       83 fb 09                cmp    $0x9,%ebx</span><br><span class="line">   280      7cf0:       75 ed                   jne    7cdf &lt;bootmain+0xe&gt;</span><br><span class="line">   281  bootmain(void) &#123;</span><br><span class="line">   282      &#x2F;&#x2F; read the 1st page off disk</span><br><span class="line">   283      readseg((uintptr_t)ELFHDR, SECTSIZE * 8, 0);</span><br><span class="line">   284</span><br><span class="line">   285      &#x2F;&#x2F; is this a valid ELF?</span><br><span class="line">   286      if (ELFHDR-&gt;e_magic !&#x3D; ELF_MAGIC) &#123;</span><br><span class="line">   287      7cf2:       81 3d 00 00 01 00 7f    cmpl   $0x464c457f,0x10000</span><br><span class="line">   288      7cf9:       45 4c 46</span><br><span class="line">   289      7cfc:       75 6a                   jne    7d68 &lt;bootmain+0x97&gt;</span><br><span class="line">   290      &#125;</span><br><span class="line">   291</span><br><span class="line">   292      struct proghdr *ph, *eph;</span><br><span class="line">   293</span><br><span class="line">   294      &#x2F;&#x2F; load each program segment (ignores ph flags)</span><br><span class="line">   295      ph &#x3D; (struct proghdr *)((uintptr_t)ELFHDR + ELFHDR-&gt;e_phoff);</span><br><span class="line">   296      7cfe:       a1 1c 00 01 00          mov    0x1001c,%eax</span><br><span class="line">   297      7d03:       8d 98 00 00 01 00       lea    0x10000(%eax),%ebx</span><br><span class="line">   298      eph &#x3D; ph + ELFHDR-&gt;e_phnum;</span><br><span class="line">   299      7d09:       0f b7 05 2c 00 01 00    movzwl 0x1002c,%eax</span><br><span class="line">   300      7d10:       c1 e0 05                shl    $0x5,%eax</span><br><span class="line">   301      7d13:       01 d8                   add    %ebx,%eax</span><br><span class="line">   302      7d15:       89 45 e4                mov    %eax,-0x1c(%ebp)</span><br><span class="line">   303      for (; ph &lt; eph; ph ++) &#123;</span><br><span class="line">   304      7d18:       3b 5d e4                cmp    -0x1c(%ebp),%ebx</span><br><span class="line">   305      7d1b:       73 3f                   jae    7d5c &lt;bootmain+0x8b&gt;</span><br><span class="line">   306          readseg(ph-&gt;p_va &amp; 0xFFFFFF, ph-&gt;p_memsz, ph-&gt;p_offset);</span><br><span class="line">   307      7d1d:       8b 73 08                mov    0x8(%ebx),%esi</span><br><span class="line">   308   * readseg - read @count bytes at @offset from kernel into virtual address @va,</span><br><span class="line">   309   * might copy more than asked.</span><br><span class="line">   310   * *&#x2F;</span><br><span class="line">   311  static void</span><br><span class="line">   312  readseg(uintptr_t va, uint32_t count, uint32_t offset) &#123;</span><br><span class="line">   313      uintptr_t end_va &#x3D; va + count;</span><br><span class="line">   314      7d20:       8b 43 14                mov    0x14(%ebx),%eax</span><br><span class="line">   315</span><br><span class="line">   316      &#x2F;&#x2F; load each program segment (ignores ph flags)</span><br><span class="line">   317      ph &#x3D; (struct proghdr *)((uintptr_t)ELFHDR + ELFHDR-&gt;e_phoff);</span><br><span class="line">   318      eph &#x3D; ph + ELFHDR-&gt;e_phnum;</span><br><span class="line">   319      for (; ph &lt; eph; ph ++) &#123;</span><br><span class="line">   320          readseg(ph-&gt;p_va &amp; 0xFFFFFF, ph-&gt;p_memsz, ph-&gt;p_offset);</span><br><span class="line">   321      7d23:       8b 4b 04                mov    0x4(%ebx),%ecx</span><br><span class="line">   322      7d26:       81 e6 ff ff ff 00       and    $0xffffff,%esi</span><br><span class="line">   323   * readseg - read @count bytes at @offset from kernel into virtual address @va,</span><br><span class="line">   324   * might copy more than asked.</span><br><span class="line">   325   * *&#x2F;</span><br><span class="line">   326  static void</span><br><span class="line">   327  readseg(uintptr_t va, uint32_t count, uint32_t offset) &#123;</span><br><span class="line">   328      uintptr_t end_va &#x3D; va + count;</span><br><span class="line">   329      7d2c:       01 f0                   add    %esi,%eax</span><br><span class="line">   330      7d2e:       89 45 e0                mov    %eax,-0x20(%ebp)</span><br><span class="line">   331</span><br><span class="line">   332      &#x2F;&#x2F; round down to sector boundary</span><br><span class="line">   333      va -&#x3D; offset % SECTSIZE;</span><br><span class="line">   334      7d31:       89 c8                   mov    %ecx,%eax</span><br><span class="line">   335      7d33:       25 ff 01 00 00          and    $0x1ff,%eax</span><br><span class="line">   336</span><br><span class="line">   337      &#x2F;&#x2F; translate from bytes to sectors; kernel starts at sector 1</span><br><span class="line">   338      uint32_t secno &#x3D; (offset &#x2F; SECTSIZE) + 1;</span><br><span class="line">   339      7d38:       c1 e9 09                shr    $0x9,%ecx</span><br><span class="line">   340  static void</span><br><span class="line">   341  readseg(uintptr_t va, uint32_t count, uint32_t offset) &#123;</span><br><span class="line">   342      uintptr_t end_va &#x3D; va + count;</span><br><span class="line">   343</span><br><span class="line">   344      &#x2F;&#x2F; round down to sector boundary</span><br><span class="line">   345      va -&#x3D; offset % SECTSIZE;</span><br><span class="line">   346      7d3b:       29 c6                   sub    %eax,%esi</span><br><span class="line">   347</span><br><span class="line">   348      &#x2F;&#x2F; translate from bytes to sectors; kernel starts at sector 1</span><br><span class="line">   349      uint32_t secno &#x3D; (offset &#x2F; SECTSIZE) + 1;</span><br><span class="line">   350      7d3d:       8d 79 01                lea    0x1(%ecx),%edi</span><br><span class="line">   351</span><br><span class="line">   352      &#x2F;&#x2F; If this is too slow, we could read lots of sectors at a time.</span><br><span class="line">   353      &#x2F;&#x2F; We&#39;d write more to memory than asked, but it doesn&#39;t matter --</span><br><span class="line">   354      &#x2F;&#x2F; we load in increasing order.</span><br><span class="line">   355      for (; va &lt; end_va; va +&#x3D; SECTSIZE, secno ++) &#123;</span><br><span class="line">   356      7d40:       3b 75 e0                cmp    -0x20(%ebp),%esi</span><br><span class="line">   357      7d43:       73 12                   jae    7d57 &lt;bootmain+0x86&gt;</span><br><span class="line">   358          readsect((void *)va, secno);</span><br><span class="line">   359      7d45:       89 fa                   mov    %edi,%edx</span><br><span class="line">   360      7d47:       89 f0                   mov    %esi,%eax</span><br><span class="line">   361      7d49:       e8 24 ff ff ff          call   7c72 &lt;readsect&gt;</span><br><span class="line">   362      uint32_t secno &#x3D; (offset &#x2F; SECTSIZE) + 1;</span><br><span class="line">   363</span><br><span class="line">   364      &#x2F;&#x2F; If this is too slow, we could read lots of sectors at a time.</span><br><span class="line">   365      &#x2F;&#x2F; We&#39;d write more to memory than asked, but it doesn&#39;t matter --</span><br><span class="line">   366      &#x2F;&#x2F; we load in increasing order.</span><br><span class="line">   367      for (; va &lt; end_va; va +&#x3D; SECTSIZE, secno ++) &#123;</span><br><span class="line">   368      7d4e:       81 c6 00 02 00 00       add    $0x200,%esi</span><br><span class="line">   369      7d54:       47                      inc    %edi</span><br><span class="line">   370      7d55:       eb e9                   jmp    7d40 &lt;bootmain+0x6f&gt;</span><br><span class="line">   371      struct proghdr *ph, *eph;</span><br><span class="line">   372</span><br><span class="line">   373      &#x2F;&#x2F; load each program segment (ignores ph flags)</span><br><span class="line">   374      ph &#x3D; (struct proghdr *)((uintptr_t)ELFHDR + ELFHDR-&gt;e_phoff);</span><br><span class="line">   375      eph &#x3D; ph + ELFHDR-&gt;e_phnum;</span><br><span class="line">   376      for (; ph &lt; eph; ph ++) &#123;</span><br><span class="line">   377      7d57:       83 c3 20                add    $0x20,%ebx</span><br><span class="line">   378      7d5a:       eb bc                   jmp    7d18 &lt;bootmain+0x47&gt;</span><br><span class="line">   379          readseg(ph-&gt;p_va &amp; 0xFFFFFF, ph-&gt;p_memsz, ph-&gt;p_offset);</span><br><span class="line">   380      &#125;</span><br><span class="line">   381</span><br><span class="line">   382      &#x2F;&#x2F; call the entry point from the ELF header</span><br><span class="line">   383      &#x2F;&#x2F; note: does not return</span><br><span class="line">   384      ((void (*)(void))(ELFHDR-&gt;e_entry &amp; 0xFFFFFF))();</span><br><span class="line">   385      7d5c:       a1 18 00 01 00          mov    0x10018,%eax</span><br><span class="line">   386      7d61:       25 ff ff ff 00          and    $0xffffff,%eax</span><br><span class="line">   387      7d66:       ff d0                   call   *%eax</span><br><span class="line">   388      asm volatile (&quot;outb %0, %1&quot; :: &quot;a&quot; (data), &quot;d&quot; (port));</span><br><span class="line">   389  &#125;</span><br><span class="line">   390</span><br><span class="line">   391  static inline void</span><br><span class="line">   392  outw(uint16_t port, uint16_t data) &#123;</span><br><span class="line">   393      asm volatile (&quot;outw %0, %1&quot; :: &quot;a&quot; (data), &quot;d&quot; (port));</span><br><span class="line">   394      7d68:       b8 00 8a ff ff          mov    $0xffff8a00,%eax</span><br><span class="line">   395      7d6d:       89 c2                   mov    %eax,%edx</span><br><span class="line">   396      7d6f:       66 ef                   out    %ax,(%dx)</span><br><span class="line">   397      7d71:       b8 00 8e ff ff          mov    $0xffff8e00,%eax</span><br><span class="line">   398      7d76:       66 ef                   out    %ax,(%dx)</span><br><span class="line">   399      7d78:       eb fe                   jmp    7d78 &lt;bootmain+0xa7&gt;</span><br></pre></td></tr></table></figure></div>
<p>在调用qemu 时增加-d in_asm -D q.log 参数，便可以将运行的汇编指令保存在q.log 中。</p>
<p>改写Makefile文件第220行</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">debug: $(UCOREIMG)</span><br><span class="line">		$(V)$(TERMINAL) -e &quot;$(QEMU) -S -s -d in_asm -D $(BINDIR)&#x2F;q.log -parallel stdio -hda $&lt; -serial null&quot;</span><br><span class="line">		$(V)sleep 2</span><br><span class="line">		$(V)$(TERMINAL) -e &quot;gdb -q -tui -x tools&#x2F;gdbinit&quot;</span><br></pre></td></tr></table></figure></div>
<p>重新make debug</p>
<p>gdb中运行命令</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">b *0x7c4a</span><br><span class="line">c</span><br></pre></td></tr></table></figure></div>
<p>得到0x7c00到bootmain函数入口前(0x7c4a)的debug的汇编指令</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">----------------</span><br><span class="line">IN:</span><br><span class="line">0x00007c00:  cli</span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">IN:</span><br><span class="line">0x00007c00:  cli</span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">IN:</span><br><span class="line">0x00007c01:  cld</span><br><span class="line">0x00007c02:  xor    %ax,%ax</span><br><span class="line">0x00007c04:  mov    %ax,%ds</span><br><span class="line">0x00007c06:  mov    %ax,%es</span><br><span class="line">0x00007c08:  mov    %ax,%ss</span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">IN:</span><br><span class="line">0x00007c0a:  in     $0x64,%al</span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">IN:</span><br><span class="line">0x00007c0c:  test   $0x2,%al</span><br><span class="line">0x00007c0e:  jne    0x7c0a</span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">IN:</span><br><span class="line">0x00007c10:  mov    $0xd1,%al</span><br><span class="line">0x00007c12:  out    %al,$0x64</span><br><span class="line">0x00007c14:  in     $0x64,%al</span><br><span class="line">0x00007c16:  test   $0x2,%al</span><br><span class="line">0x00007c18:  jne    0x7c14</span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">IN:</span><br><span class="line">0x00007c1a:  mov    $0xdf,%al</span><br><span class="line">0x00007c1c:  out    %al,$0x60</span><br><span class="line">0x00007c1e:  lgdtw  0x7c6c</span><br><span class="line">0x00007c23:  mov    %cr0,%eax</span><br><span class="line">0x00007c26:  or     $0x1,%eax</span><br><span class="line">0x00007c2a:  mov    %eax,%cr0</span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">IN:</span><br><span class="line">0x00007c2d:  ljmp   $0x8,$0x7c32</span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">IN:</span><br><span class="line">0x00007c32:  mov    $0x10,%ax</span><br><span class="line">0x00007c36:  mov    %eax,%ds</span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">IN:</span><br><span class="line">0x00007c38:  mov    %eax,%es</span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">IN:</span><br><span class="line">0x00007c3a:  mov    %eax,%fs</span><br><span class="line">0x00007c3c:  mov    %eax,%gs</span><br><span class="line">0x00007c3e:  mov    %eax,%ss</span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">IN:</span><br><span class="line">0x00007c40:  mov    $0x0,%ebp</span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">IN:</span><br><span class="line">0x00007c45:  mov    $0x7c00,%esp</span><br><span class="line">0x00007c4a:  call   0x7cd1</span><br></pre></td></tr></table></figure></div>
<p>可见三者对应且一致。</p>
<h2 id="练习24"><a class="markdownIt-Anchor" href="#练习24"></a> 练习2.4</h2>
<p>设置0x7cd7为下一个断点</p>
<p>得到bootmain对应的汇编码</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">----------------</span><br><span class="line">IN:</span><br><span class="line">0x00007cd1:  push   %ebp</span><br><span class="line">0x00007cd2:  mov    %esp,%ebp</span><br><span class="line">0x00007cd4:  push   %edi</span><br><span class="line">0x00007cd5:  push   %esi</span><br><span class="line">0x00007cd6:  push   %ebx</span><br><span class="line">0x00007cd7:  mov    $0x1,%ebx</span><br></pre></td></tr></table></figure></div>
<p>对应bootasm.S源码</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">71      call bootmain</span><br></pre></td></tr></table></figure></div>
<p>查看bootblock.asm的代码</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">233  &#x2F;* bootmain - the entry of bootloader *&#x2F;</span><br><span class="line">234  void</span><br><span class="line">235  bootmain(void) &#123;</span><br><span class="line">236      7cd1:       55                      push   %ebp</span><br><span class="line">237      7cd2:       89 e5                   mov    %esp,%ebp</span><br><span class="line">238      7cd4:       57                      push   %edi</span><br><span class="line">239      7cd5:       56                      push   %esi</span><br><span class="line">240      7cd6:       53                      push   %ebx</span><br><span class="line">241</span><br><span class="line">242      &#x2F;&#x2F; round down to sector boundary</span><br><span class="line">243      va -&#x3D; offset % SECTSIZE;</span><br><span class="line">244</span><br><span class="line">245      &#x2F;&#x2F; translate from bytes to sectors; kernel starts at sector 1</span><br><span class="line">246      uint32_t secno &#x3D; (offset &#x2F; SECTSIZE) + 1;</span><br><span class="line">247      7cd7:       bb 01 00 00 00          mov    $0x1,%ebx</span><br><span class="line">248      &#125;</span><br></pre></td></tr></table></figure></div>
<p>三者对应</p>
<h1 id="练习3分析bootloader进入保护模式的过程"><a class="markdownIt-Anchor" href="#练习3分析bootloader进入保护模式的过程"></a> 练习3：分析bootloader进入保护模式的过程。</h1>
<p>BIOS将通过读取硬盘主引导扇区到内存，并转跳到对应内存中的位置执行bootloader。请分析bootloader是如何完成从实模式进入保护模式的。</p>
<p>提示：需要阅读**小节“保护模式和分段机制”**和lab1/boot/bootasm.S源码，了解如何从实模式切换到保护模式，需要了解：</p>
<ul>
<li>
<p>为何开启A20，以及如何开启A20</p>
</li>
<li>
<p>如何初始化GDT表</p>
</li>
<li>
<p>如何使能和进入保护模式</p>
</li>
</ul>
<h2 id="bootasms-源码"><a class="markdownIt-Anchor" href="#bootasms-源码"></a> bootasm.S 源码</h2>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">moocos-&gt; cat boot&#x2F;bootasm.S -n</span><br><span class="line">    1  #include &lt;asm.h&gt;</span><br><span class="line">    2  #导入asm.h头文件，用于定义GDT，GDT是保护模式使用的全局段描述表，其中存储者段描述符</span><br><span class="line">    3  # Start the CPU: switch to 32-bit protected mode, jump into C.</span><br><span class="line">    4  # The BIOS loads this code from the first sector of the hard disk into</span><br><span class="line">    5  # memory at physical address 0x7c00 and starts executing in real mode</span><br><span class="line">    6  # with %cs&#x3D;0 %ip&#x3D;7c00.</span><br><span class="line">    7  # 此处注释说明了此段代码的目的是启动保护模式，转入C。计算机加电后，由BIOS将bootasm.S生成的可执行代码从硬盘的第一个扇区复制到内存中的物理地址0x7c00处,并开始执行。此时系统处于实模式。可用内存不多于1M。</span><br><span class="line">    8  .set PROT_MODE_CSEG,        0x8                     # kernel code segment selector</span><br><span class="line">    9  .set PROT_MODE_DSEG,        0x10                    # kernel data segment selector</span><br><span class="line">    # 这两个段选择子提供了gdt中代码段和数据段的索引</span><br><span class="line">   10  .set CR0_PE_ON,             0x1                     # protected mode enable flag</span><br><span class="line">   # 此变量是开启A20地址线的标志，为1是开启保护模式</span><br><span class="line">   11</span><br><span class="line">   12  # start address should be 0:7c00, in real mode, the beginning address of the running bootloader</span><br><span class="line">   13  .globl start</span><br><span class="line">   14  start:</span><br><span class="line">   #此处相当于C语言的main函数，是BIOS调用程序的执行入口</span><br><span class="line">   15  .code16                                             # Assemble for 16-bit mode</span><br><span class="line">   16      cli                                             # Disable interrupts </span><br><span class="line">   17      cld                                             # String operations increment #使方向标志位复位</span><br><span class="line">   18</span><br><span class="line">   19      # Set up the important data segment registers (DS, ES, SS).</span><br><span class="line">   20      xorw %ax, %ax                                   # Segment number zero #将ax清零</span><br><span class="line">   21      movw %ax, %ds                                   # -&gt; Data Segment     </span><br><span class="line">   22      movw %ax, %es                                   # -&gt; Extra Segment</span><br><span class="line">   23      movw %ax, %ss                                   # -&gt; Stack Segment</span><br><span class="line">   24 #上面三段是汇编常写的三段代码，将段选择子清零</span><br><span class="line">   25      # Enable A20:</span><br><span class="line">   26      #  For backwards compatibility with the earliest PCs, physical</span><br><span class="line">   27      #  address line 20 is tied low, so that addresses higher than</span><br><span class="line">   28      #  1MB wrap around to zero by default. This code undoes this.</span><br><span class="line">     #为了与最早的PC向后兼容，物理地址线20设置为低电平，因此高于1MB的地址默认情况下会回零。 此代码撤消了此操作。</span><br><span class="line">     # 接下来是激活保护模式</span><br><span class="line">     #由于历史原因A20地址位由键盘控制器芯片8042管理。所以要给8042发命令激活A20，8042有两个IO端口：0x60和0x64， 激活流程位： 发送0xd1命令到0x64端口 --&gt; 发送0xdf到0x60</span><br><span class="line">   29  seta20.1:</span><br><span class="line">   30      inb $0x64, %al                                  # Wait for not busy(8042 input buffer empty). #读入数据</span><br><span class="line">   31      testb $0x2, %al</span><br><span class="line">   32      jnz seta20.1</span><br><span class="line">   33      #发送命令之前，要等待键盘输入缓冲区为空，这通过8042的状态寄存器的第2bit来观察，而状态寄存器的值可以读0x64端口得到。上面的指令的意思就是，如果状态寄存器的第2位为1，就跳到seta20.1符号处执行，知道第2位为0，代表缓冲区为空</span><br><span class="line">   34      movb $0xd1, %al                                 # 0xd1 -&gt; port 0x64</span><br><span class="line">   35      outb %al, $0x64                                 # 0xd1 means: write data to 8042&#39;s P2 port</span><br><span class="line">   36  # 将数据0xd1写入0x64 IO端口</span><br><span class="line">   37  seta20.2:</span><br><span class="line">   38      inb $0x64, %al                                  # Wait for not busy(8042 input buffer empty).</span><br><span class="line">   39      testb $0x2, %al</span><br><span class="line">   40      jnz seta20.2</span><br><span class="line">   41</span><br><span class="line">   42      movb $0xdf, %al                                 # 0xdf -&gt; port 0x60</span><br><span class="line">   43      outb %al, $0x60                                 # 0xdf &#x3D; 11011111, means set P2&#39;s A20 bit(the 1 bit) to 1</span><br><span class="line">   44      #此处A20激活成功</span><br><span class="line">   45      # Switch from real to protected mode, using a bootstrap GDT</span><br><span class="line">   46      # and segment translation that makes virtual addresses</span><br><span class="line">   47      # identical to physical addresses, so that the</span><br><span class="line">   48      # effective memory map does not change during the switch.</span><br><span class="line">   #转入保护模式，这里需要指定一个临时的GDT，来翻译逻辑（虚拟）地址。这里使用的GDT通过gdtdesc段定义。它翻译得到的物理地址和虚拟地址相同，所以转换过程中内存映射不会改变</span><br><span class="line">   49      lgdt gdtdesc #载入gdt</span><br><span class="line">   50      movl %cr0, %eax </span><br><span class="line">   51      orl $CR0_PE_ON, %eax</span><br><span class="line">   52      movl %eax, %cr0</span><br><span class="line">   53      #打开保护模式标志位，开启保护模式，cr0寄存器的第0位就是这个开关，通过CR0_PE_ON或cr0寄存器，将第0位置1</span><br><span class="line">   54      # Jump to next instruction, but in 32-bit code segment.</span><br><span class="line">   55      # Switches processor into 32-bit mode.</span><br><span class="line">   56      ljmp $PROT_MODE_CSEG, $protcseg</span><br><span class="line">   57      #开保护模式之后就要使用逻辑地址。</span><br><span class="line">   58  .code32                                             # Assemble for 32-bit mode</span><br><span class="line">   59  protcseg:</span><br><span class="line">   60      # Set up the protected-mode data segment registers</span><br><span class="line">   61      movw $PROT_MODE_DSEG, %ax                       # Our data segment selector</span><br><span class="line">   62      movw %ax, %ds                                   # -&gt; DS: Data Segment</span><br><span class="line">   63      movw %ax, %es                                   # -&gt; ES: Extra Segment</span><br><span class="line">   64      movw %ax, %fs                                   # -&gt; FS</span><br><span class="line">   65      movw %ax, %gs                                   # -&gt; GS</span><br><span class="line">   66      movw %ax, %ss                                   # -&gt; SS: Stack Segment</span><br><span class="line">   67      #设置段寄存器，并建立堆栈。</span><br><span class="line">   68      # Set up the stack pointer and call into C. The stack region is from 0--start(0x7c00)</span><br><span class="line">   69      movl $0x0, %ebp</span><br><span class="line">   70      movl $start, %esp</span><br><span class="line">   71      call bootmain</span><br><span class="line">   72#栈顶设定在start处，也就是地址0x7c00处，call函数将返回地址入栈，将控制权交给bootmain主方法</span><br><span class="line">   73      # If bootmain returns (it shouldn&#39;t), loop.</span><br><span class="line">   74  spin:</span><br><span class="line">   75      jmp spin   #死循环</span><br><span class="line">   76</span><br><span class="line">   77  # Bootstrap GDT</span><br><span class="line">   78  .p2align 2                                          # force 4 byte alignment</span><br><span class="line">   79  gdt:</span><br><span class="line">   80      SEG_NULLASM                                     # null seg</span><br><span class="line">   81      SEG_ASM(STA_X|STA_R, 0x0, 0xffffffff)           # code seg for bootloader and kernel</span><br><span class="line">   82      SEG_ASM(STA_W, 0x0, 0xffffffff)                 # data seg for bootloader and kernel</span><br><span class="line">   83</span><br><span class="line">   84  gdtdesc:</span><br><span class="line">   85      .word 0x17                                      # sizeof(gdt) - 1</span><br><span class="line">   86      .long gdt                                       # address gdt</span><br></pre></td></tr></table></figure></div>
<p>asm.h的内容</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="C"><figure class="iseeu highlight /c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">moocos-&gt; cat boot/<span class="keyword">asm</span>.h -n</span><br><span class="line">     <span class="number">1</span>  <span class="meta">#<span class="meta-keyword">ifndef</span> __BOOT_ASM_H__</span></span><br><span class="line">     <span class="number">2</span>  <span class="meta">#<span class="meta-keyword">define</span> __BOOT_ASM_H__</span></span><br><span class="line">     <span class="number">3</span></span><br><span class="line">     <span class="number">4</span>  <span class="comment">/* Assembler macros to create x86 segments */</span></span><br><span class="line">     <span class="number">5</span></span><br><span class="line">     <span class="number">6</span>  <span class="comment">/* Normal segment */</span></span><br><span class="line">     <span class="number">7</span>  <span class="meta">#<span class="meta-keyword">define</span> SEG_NULLASM                                             \</span></span><br><span class="line">     <span class="number">8</span>      .<span class="keyword">word</span> <span class="number">0</span>, <span class="number">0</span>;                                                 \</span><br><span class="line">     <span class="number">9</span>      .<span class="keyword">byte</span> <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="number">10</span></span><br><span class="line">    <span class="number">11</span>  <span class="meta">#<span class="meta-keyword">define</span> SEG_ASM(type,base,lim)                                  \</span></span><br><span class="line">    <span class="number">12</span>      .<span class="keyword">word</span> (((lim) &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0xffff</span>), ((base) &amp; <span class="number">0xffff</span>);          \</span><br><span class="line">    <span class="number">13</span>      .<span class="keyword">byte</span> (((base) &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>), (<span class="number">0x90</span> | (type)),             \</span><br><span class="line">    <span class="number">14</span>          (<span class="number">0xC0</span> | (((lim) &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0xf</span>)), (((base) &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>)</span><br><span class="line">    <span class="number">15</span></span><br><span class="line">    <span class="number">16</span></span><br><span class="line">    <span class="number">17</span>  <span class="comment">/* Application segment type bits */</span></span><br><span class="line">    <span class="number">18</span>  <span class="meta">#<span class="meta-keyword">define</span> STA_X       0x8     <span class="comment">// Executable segment</span></span></span><br><span class="line">    <span class="number">19</span>  <span class="meta">#<span class="meta-keyword">define</span> STA_E       0x4     <span class="comment">// Expand down (non-executable segments)</span></span></span><br><span class="line">    <span class="number">20</span>  <span class="meta">#<span class="meta-keyword">define</span> STA_C       0x4     <span class="comment">// Conforming code segment (executable only)</span></span></span><br><span class="line">    <span class="number">21</span>  <span class="meta">#<span class="meta-keyword">define</span> STA_W       0x2     <span class="comment">// Writeable (non-executable segments)</span></span></span><br><span class="line">    <span class="number">22</span>  <span class="meta">#<span class="meta-keyword">define</span> STA_R       0x2     <span class="comment">// Readable (executable segments)</span></span></span><br><span class="line">    <span class="number">23</span>  <span class="meta">#<span class="meta-keyword">define</span> STA_A       0x1     <span class="comment">// Accessed</span></span></span><br><span class="line">    <span class="number">24</span></span><br><span class="line">    <span class="number">25</span>  <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* !__BOOT_ASM_H__ */</span></span></span><br><span class="line">    <span class="number">26</span></span><br></pre></td></tr></table></figure></div>
<h2 id="练习31"><a class="markdownIt-Anchor" href="#练习31"></a> 练习3.1</h2>
<blockquote>
<p>为何开启A20，以及如何开启A20</p>
</blockquote>
<p>当A20地址线控制禁止时，程序就像运行在8086上，1MB以上的地址是不可访问的，只能访问奇数MB的不连续的地址。为了使能所有地址位的寻址能力，必须向键盘控制器8082发送一个命令，键盘控制器8042会将A20线置于高电位，使全部32条地址线可用，实现访问4GB内存。</p>
<p>激活方法：要给8042发命令激活A20，8042有两个IO端口：0x60和0x64， 激活流程位： 发送0xd1命令到0x64端口 --&gt; 发送0xdf到0x60</p>
<h2 id="练习32"><a class="markdownIt-Anchor" href="#练习32"></a> 练习3.2</h2>
<blockquote>
<p>如何初始化GDT表</p>
</blockquote>
<p>**全局描述符表(GDT)**的是提供内存保护。在80286之前的处理器中只有实模式，所有程序都可访问任意内存。GDT是保护模式下限制非法内存访问的一种方式。</p>
<p>直接载入gpt</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lgdt gdtdesc #载入gdt</span><br></pre></td></tr></table></figure></div>
<h2 id="练习33"><a class="markdownIt-Anchor" href="#练习33"></a> 练习3.3</h2>
<blockquote>
<p>如何使能和进入保护模式</p>
</blockquote>
<p>通过CR0_PE_ON或cr0寄存器，将第0位置1</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">50      movl %cr0, %eax </span><br><span class="line">51      orl $CR0_PE_ON, %eax</span><br><span class="line">52      movl %eax, %cr0</span><br></pre></td></tr></table></figure></div>
<h1 id="练习4分析bootloader加载elf格式的os的过程"><a class="markdownIt-Anchor" href="#练习4分析bootloader加载elf格式的os的过程"></a> 练习4：分析bootloader加载ELF格式的OS的过程。</h1>
<p>通过阅读bootmain.c，了解bootloader如何加载ELF文件。通过分析源代码和通过qemu来运行并调试bootloader&amp;OS，</p>
<ul>
<li>bootloader如何读取硬盘扇区的？</li>
<li>bootloader是如何加载ELF格式的OS？</li>
</ul>
<p>提示：可阅读“硬盘访问概述”，“ELF执行文件格式概述”这两小节。</p>
<h2 id="bootmainc源码"><a class="markdownIt-Anchor" href="#bootmainc源码"></a> bootmain.c源码</h2>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="C"><figure class="iseeu highlight /c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">moocos-&gt; cat boot/bootmain.c -n</span><br><span class="line">     <span class="number">1</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;defs.h&gt;</span></span></span><br><span class="line">     <span class="number">2</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;x86.h&gt;</span></span></span><br><span class="line">     <span class="number">3</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;elf.h&gt;</span></span></span><br><span class="line">     <span class="number">4</span></span><br><span class="line">     <span class="number">5</span>   <span class="comment">/* *************************************************** **********************</span></span><br><span class="line"><span class="comment">     6 这是一个非常简单的引导加载程序，它的唯一工作就是引导</span></span><br><span class="line"><span class="comment">     7 *来自第一个IDE硬盘的ELF内核映像。</span></span><br><span class="line"><span class="comment">     8 *</span></span><br><span class="line"><span class="comment">     9 *磁盘布局</span></span><br><span class="line"><span class="comment">    10 * *该程序（bootasm.S和bootmain.c）是引导加载程序。</span></span><br><span class="line"><span class="comment">    11 *应该存储在磁盘的第一个扇区中。</span></span><br><span class="line"><span class="comment">    12 *</span></span><br><span class="line"><span class="comment">    13 * *第二个扇区开始保存内核映像。</span></span><br><span class="line"><span class="comment">    14 *</span></span><br><span class="line"><span class="comment">    15 * *内核映像必须为ELF格式。</span></span><br><span class="line"><span class="comment">    16 *</span></span><br><span class="line"><span class="comment">    17 *启动步骤</span></span><br><span class="line"><span class="comment">    18 * *当CPU启动时，它将BIOS加载到内存中并执行</span></span><br><span class="line"><span class="comment">    19 *</span></span><br><span class="line"><span class="comment">    20 * * BIOS初始化设备，中断例程集以及</span></span><br><span class="line"><span class="comment">    21 *读取引导设备的第一个扇区（例如，硬盘驱动器）</span></span><br><span class="line"><span class="comment">    22 *进入内存并跳转到它。</span></span><br><span class="line"><span class="comment">    23 *</span></span><br><span class="line"><span class="comment">    24 * *假设此引导加载程序存储在磁盘的第一个扇区中</span></span><br><span class="line"><span class="comment">    25 *硬盘，此代码接管...</span></span><br><span class="line"><span class="comment">    26 *</span></span><br><span class="line"><span class="comment">    27 * *控制从bootasm.S开始-设置保护模式，</span></span><br><span class="line"><span class="comment">    28 *和一个堆栈，然后运行C代码，然后调用bootmain（）</span></span><br><span class="line"><span class="comment">    29 *</span></span><br><span class="line"><span class="comment">    该文件中的30 * * bootmain（）接管，读取内核并跳转到该内核。</span></span><br><span class="line"><span class="comment">    31 * */</span></span><br><span class="line">    <span class="number">32</span></span><br><span class="line">    <span class="number">33</span>  <span class="meta">#<span class="meta-keyword">define</span> SECTSIZE        512</span></span><br><span class="line">    <span class="number">34</span>  <span class="meta">#<span class="meta-keyword">define</span> ELFHDR          ((struct elfhdr *)0x10000)      <span class="comment">//暂存空间</span></span></span><br><span class="line">    <span class="number">35</span></span><br><span class="line">    <span class="number">36</span>  <span class="comment">/* waitdisk-等待磁盘就绪 */</span></span><br><span class="line">    <span class="number">37</span>  <span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">    <span class="number">38</span>  waitdisk(<span class="keyword">void</span>) &#123;</span><br><span class="line">    <span class="number">39</span>      <span class="keyword">while</span> ((inb(<span class="number">0x1F7</span>) &amp; <span class="number">0xC0</span>) != <span class="number">0x40</span>)</span><br><span class="line">    <span class="number">40</span>          <span class="comment">/* do nothing */</span>;</span><br><span class="line">    <span class="number">41</span>  &#125;</span><br><span class="line">    <span class="number">42</span></span><br><span class="line">    <span class="number">43</span>  <span class="comment">/* readsect-将@secno的单个扇区读入@dst */</span></span><br><span class="line">    <span class="number">44</span>  <span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">    <span class="number">45</span>  readsect(<span class="keyword">void</span> *dst, <span class="keyword">uint32_t</span> secno) &#123;</span><br><span class="line">    <span class="number">46</span>      <span class="comment">//等待磁盘准备好</span></span><br><span class="line">    <span class="number">47</span>      waitdisk();</span><br><span class="line">    <span class="number">48</span></span><br><span class="line">    <span class="number">49</span>      outb(<span class="number">0x1F2</span>, <span class="number">1</span>);                         <span class="comment">// count = 1</span></span><br><span class="line">    <span class="number">50</span>      outb(<span class="number">0x1F3</span>, secno &amp; <span class="number">0xFF</span>);</span><br><span class="line">    <span class="number">51</span>      outb(<span class="number">0x1F4</span>, (secno &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">    <span class="number">52</span>      outb(<span class="number">0x1F5</span>, (secno &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">    <span class="number">53</span>      outb(<span class="number">0x1F6</span>, ((secno &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xF</span>) | <span class="number">0xE0</span>);</span><br><span class="line">    <span class="number">54</span>      outb(<span class="number">0x1F7</span>, <span class="number">0x20</span>);                      <span class="comment">// cmd 0x20 - read 读取扇区</span></span><br><span class="line">    <span class="number">55</span></span><br><span class="line">    <span class="number">56</span>      <span class="comment">//等待磁盘准备好</span></span><br><span class="line">    <span class="number">57</span>      waitdisk();</span><br><span class="line">    <span class="number">58</span></span><br><span class="line">    <span class="number">59</span>      <span class="comment">//读一个扇区</span></span><br><span class="line">    <span class="number">60</span>      insl(<span class="number">0x1F0</span>, dst, SECTSIZE / <span class="number">4</span>);</span><br><span class="line">    <span class="number">61</span>  &#125;</span><br><span class="line">    <span class="number">62</span></span><br><span class="line">    <span class="number">63</span>  <span class="comment">/* *</span></span><br><span class="line"><span class="comment">    64 * readseg-从内核将@count处的@count字节读取到虚拟地址@va中，</span></span><br><span class="line"><span class="comment">    65 *可能会复印超过要求的数量。</span></span><br><span class="line"><span class="comment">    66 * */</span></span><br><span class="line">    <span class="number">67</span>  <span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">    <span class="number">68</span>  readseg(<span class="keyword">uintptr_t</span> va, <span class="keyword">uint32_t</span> count, <span class="keyword">uint32_t</span> offset) &#123;</span><br><span class="line">    <span class="number">69</span>      <span class="keyword">uintptr_t</span> end_va = va + count;</span><br><span class="line">    <span class="number">70</span></span><br><span class="line">    <span class="number">71</span>      <span class="comment">//向下舍入到扇区边界</span></span><br><span class="line">    <span class="number">72</span>      va -= offset % SECTSIZE;</span><br><span class="line">    <span class="number">73</span></span><br><span class="line">    <span class="number">74</span>      <span class="comment">//从字节转换为扇区;内核从扇区1开始</span></span><br><span class="line">    <span class="number">75</span>      <span class="keyword">uint32_t</span> secno = (offset / SECTSIZE) + <span class="number">1</span>;</span><br><span class="line">    <span class="number">76</span>		<span class="comment">//如果太慢，我们可以一次读取很多扇区。</span></span><br><span class="line">    <span class="number">78</span>       <span class="comment">//我们向内存中写入的内容超出了要求，但这没关系-</span></span><br><span class="line">    <span class="number">79</span>       <span class="comment">//我们按升序加载。</span></span><br><span class="line">    <span class="number">80</span>      <span class="keyword">for</span> (; va &lt; end_va; va += SECTSIZE, secno ++) &#123;</span><br><span class="line">    <span class="number">81</span>          readsect((<span class="keyword">void</span> *)va, secno);</span><br><span class="line">    <span class="number">82</span>      &#125;</span><br><span class="line">    <span class="number">83</span>  &#125;</span><br><span class="line">    <span class="number">84</span></span><br><span class="line">    <span class="number">85</span>  <span class="comment">/* bootmain-引导加载程序的条目*/</span></span><br><span class="line">    <span class="number">86</span>  <span class="keyword">void</span></span><br><span class="line">    <span class="number">87</span>  bootmain(<span class="keyword">void</span>) &#123;</span><br><span class="line">    <span class="number">88</span>      <span class="comment">// 首先读取ELF的头部</span></span><br><span class="line">    <span class="number">89</span>      readseg((<span class="keyword">uintptr_t</span>)ELFHDR, SECTSIZE * <span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="number">90</span></span><br><span class="line">    <span class="number">91</span>       <span class="comment">// 通过储存在头部的幻数判断是否是合法的ELF文件</span></span><br><span class="line">    <span class="number">92</span>      <span class="keyword">if</span> (ELFHDR-&gt;e_magic != ELF_MAGIC) &#123;</span><br><span class="line">    <span class="number">93</span>          <span class="keyword">goto</span> bad;</span><br><span class="line">    <span class="number">94</span>      &#125;</span><br><span class="line">    <span class="number">95</span></span><br><span class="line">    <span class="number">96</span>      <span class="class"><span class="keyword">struct</span> <span class="title">proghdr</span> *<span class="title">ph</span>, *<span class="title">eph</span>;</span></span><br><span class="line">    <span class="number">97</span></span><br><span class="line">    <span class="number">98</span>      <span class="comment">// ELF头部有描述ELF文件应加载到内存什么位置的描述表, 先将描述表的头地址存在ph</span></span><br><span class="line">    <span class="number">99</span>      ph = (struct proghdr *)((<span class="keyword">uintptr_t</span>)ELFHDR + ELFHDR-&gt;e_phoff);</span><br><span class="line">   <span class="number">100</span>      eph = ph + ELFHDR-&gt;e_phnum;</span><br><span class="line">            <span class="comment">// 按照描述表将ELF文件中数据载入内存</span></span><br><span class="line">   <span class="number">101</span>      <span class="keyword">for</span> (; ph &lt; eph; ph ++) &#123;</span><br><span class="line">   <span class="number">102</span>          readseg(ph-&gt;p_va &amp; <span class="number">0xFFFFFF</span>, ph-&gt;p_memsz, ph-&gt;p_offset);</span><br><span class="line">   <span class="number">103</span>      &#125;</span><br><span class="line">           <span class="comment">// ELF文件0x1000位置后面的0xd1ec比特被载入内存0x00100000</span></span><br><span class="line">           <span class="comment">// ELF文件0xf000位置后面的0x1d20比特被载入内存0x0010e000</span></span><br><span class="line">   <span class="number">104</span></span><br><span class="line">   <span class="number">105</span>      <span class="comment">// 根据ELF头部储存的入口信息，找到内核的入口</span></span><br><span class="line">   <span class="number">106</span>      <span class="comment">//注意：不返回 --死循环</span></span><br><span class="line">   <span class="number">107</span>      ((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))(ELFHDR-&gt;e_entry &amp; <span class="number">0xFFFFFF</span>))();</span><br><span class="line">   <span class="number">108</span></span><br><span class="line">   <span class="number">109</span>  bad:</span><br><span class="line">   <span class="number">110</span>      outw(<span class="number">0x8A00</span>, <span class="number">0x8A00</span>);</span><br><span class="line">   <span class="number">111</span>      outw(<span class="number">0x8A00</span>, <span class="number">0x8E00</span>);</span><br><span class="line">   <span class="number">112</span></span><br><span class="line">   <span class="number">113</span>      <span class="comment">/* do nothing */</span></span><br><span class="line">   <span class="number">114</span>      <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">   <span class="number">115</span>  &#125;</span><br><span class="line">   <span class="number">116</span></span><br></pre></td></tr></table></figure></div>
<h2 id="练习41"><a class="markdownIt-Anchor" href="#练习41"></a> 练习4.1</h2>
<p>bootloader如何读取硬盘扇区的？</p>
<p>读取扇区代码</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="C"><figure class="iseeu highlight /c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">36</span>  <span class="comment">/* waitdisk-等待磁盘就绪 */</span></span><br><span class="line"><span class="number">37</span>  <span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line"><span class="number">38</span>  waitdisk(<span class="keyword">void</span>) &#123;</span><br><span class="line"><span class="number">39</span>      <span class="keyword">while</span> ((inb(<span class="number">0x1F7</span>) &amp; <span class="number">0xC0</span>) != <span class="number">0x40</span>)</span><br><span class="line"><span class="number">40</span>          <span class="comment">/* do nothing */</span>;</span><br><span class="line"><span class="number">41</span>  &#125;</span><br><span class="line"><span class="number">42</span></span><br><span class="line"><span class="number">43</span>  <span class="comment">/* readsect-将@secno的单个扇区读入@dst */</span></span><br><span class="line"><span class="number">44</span>  <span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line"><span class="number">45</span>  readsect(<span class="keyword">void</span> *dst, <span class="keyword">uint32_t</span> secno) &#123;</span><br><span class="line"><span class="number">46</span>      <span class="comment">//等待磁盘准备好</span></span><br><span class="line"><span class="number">47</span>      waitdisk();</span><br><span class="line"><span class="number">48</span></span><br><span class="line"><span class="number">49</span>      outb(<span class="number">0x1F2</span>, <span class="number">1</span>);                         <span class="comment">// count = 1</span></span><br><span class="line"><span class="number">50</span>      outb(<span class="number">0x1F3</span>, secno &amp; <span class="number">0xFF</span>);</span><br><span class="line"><span class="number">51</span>      outb(<span class="number">0x1F4</span>, (secno &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line"><span class="number">52</span>      outb(<span class="number">0x1F5</span>, (secno &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line"><span class="number">53</span>      outb(<span class="number">0x1F6</span>, ((secno &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xF</span>) | <span class="number">0xE0</span>);</span><br><span class="line"><span class="number">54</span>      outb(<span class="number">0x1F7</span>, <span class="number">0x20</span>);                      <span class="comment">// cmd 0x20 - read 读取扇区</span></span><br><span class="line"><span class="number">55</span></span><br><span class="line"><span class="number">56</span>      <span class="comment">//等待磁盘准备好</span></span><br><span class="line"><span class="number">57</span>      waitdisk();</span><br><span class="line"><span class="number">58</span></span><br><span class="line"><span class="number">59</span>      <span class="comment">//读一个扇区</span></span><br><span class="line"><span class="number">60</span>      insl(<span class="number">0x1F0</span>, dst, SECTSIZE / <span class="number">4</span>);</span><br><span class="line"><span class="number">61</span>  &#125;</span><br></pre></td></tr></table></figure></div>
<p>磁盘IO各个端口作用</p>
<table>
<thead>
<tr>
<th>IO地址</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x1f0</td>
<td>读数据，当0x1f7不为忙状态时，可以读。</td>
</tr>
<tr>
<td>0x1f2</td>
<td>要读写的扇区数，每次读写前，你需要表明你要读写几个扇区。最小是1个扇区</td>
</tr>
<tr>
<td>0x1f3</td>
<td>如果是LBA模式，就是LBA参数的0-7位</td>
</tr>
<tr>
<td>0x1f4</td>
<td>如果是LBA模式，就是LBA参数的8-15位</td>
</tr>
<tr>
<td>0x1f5</td>
<td>如果是LBA模式，就是LBA参数的16-23位</td>
</tr>
<tr>
<td>0x1f6</td>
<td>第0~3位：如果是LBA模式就是24-27位 第4位：为0主盘；为1从盘</td>
</tr>
<tr>
<td>0x1f7</td>
<td>状态和命令寄存器。操作时先给命令，再读取，如果不是忙状态就从0x1f0端口读数据</td>
</tr>
</tbody>
</table>
<ol>
<li>待硬盘空闲。waitdisk的函数实现只有一行：<code>while ((inb(0x1F7) &amp; 0xC0) != 0x40)</code>，0xC0=1100 0000 b，0x40=0100 0000b，意思是不断查询读0x1F7寄存器的最高两位，直到最高位为0、次高位为1（这个状态应该意味着磁盘空闲）才返回。</li>
<li>硬盘空闲后，发出读取扇区的命令。对应的命令字为0x20，放在0x1F7寄存器中；读取的扇区数为1，放在0x1F2寄存器中；读取的扇区起始编号共28位，分成4部分依次放在0x1F3~0x1F6寄存器中。</li>
<li>发出命令后，再次等待硬盘空闲。</li>
<li>硬盘再次空闲后，开始从0x1F0寄存器中读数据。注意insl的作用是&quot;That function will read cnt dwords from the input port specified by port into the supplied output array addr.&quot;，是以dword即4字节为单位的，因此这里SECTIZE需要除以4</li>
</ol>
<p>bootblock.asm中的insl函数定义</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*包含3个输入参数，port代表端口号，addr代表这个扇区存放在主存中的起始地址，cnt则代表读取的次数*&#x2F;</span><br><span class="line">212  static inline void</span><br><span class="line">213  insl(uint32_t port, void *addr, int cnt) &#123;</span><br><span class="line">214      asm volatile (</span><br><span class="line">215      7cc1:       b9 80 00 00 00          mov    $0x80,%ecx</span><br><span class="line">216      7cc6:       ba f0 01 00 00          mov    $0x1f0,%edx</span><br><span class="line">217      7ccb:       fc                      cld</span><br><span class="line">218      7ccc:       f2 6d                   repnz insl (%dx),%es:(%edi)</span><br><span class="line">219      &#x2F;&#x2F; wait for disk to be ready</span><br><span class="line">220      waitdisk();</span><br><span class="line">221</span><br><span class="line">222      &#x2F;&#x2F; read a sector</span><br><span class="line">223      insl(0x1F0, dst, SECTSIZE &#x2F; 4);</span><br><span class="line">224  &#125;</span><br></pre></td></tr></table></figure></div>
<h2 id="练习42"><a class="markdownIt-Anchor" href="#练习42"></a> 练习4.2</h2>
<p>bootloader是如何加载ELF格式的OS？</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="C"><figure class="iseeu highlight /c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">85</span>  <span class="comment">/* bootmain-引导加载程序的条目*/</span></span><br><span class="line"> <span class="number">86</span>  <span class="keyword">void</span></span><br><span class="line"> <span class="number">87</span>  bootmain(<span class="keyword">void</span>) &#123;</span><br><span class="line"> <span class="number">88</span>      <span class="comment">// 首先读取ELF的头部</span></span><br><span class="line"> <span class="number">89</span>      readseg((<span class="keyword">uintptr_t</span>)ELFHDR, SECTSIZE * <span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line"> <span class="number">90</span></span><br><span class="line"> <span class="number">91</span>       <span class="comment">// 通过储存在头部的幻数判断是否是合法的ELF文件</span></span><br><span class="line"> <span class="number">92</span>      <span class="keyword">if</span> (ELFHDR-&gt;e_magic != ELF_MAGIC) &#123;</span><br><span class="line"> <span class="number">93</span>          <span class="keyword">goto</span> bad;</span><br><span class="line"> <span class="number">94</span>      &#125;</span><br><span class="line"> <span class="number">95</span></span><br><span class="line"> <span class="number">96</span>      <span class="class"><span class="keyword">struct</span> <span class="title">proghdr</span> *<span class="title">ph</span>, *<span class="title">eph</span>;</span></span><br><span class="line"> <span class="number">97</span></span><br><span class="line"> <span class="number">98</span>      <span class="comment">// ELF头部有描述ELF文件应加载到内存什么位置的描述表, 先将描述表的头地址存在ph</span></span><br><span class="line"> <span class="number">99</span>      ph = (struct proghdr *)((<span class="keyword">uintptr_t</span>)ELFHDR + ELFHDR-&gt;e_phoff);</span><br><span class="line"><span class="number">100</span>      eph = ph + ELFHDR-&gt;e_phnum;</span><br><span class="line">         <span class="comment">// 按照描述表将ELF文件中数据载入内存</span></span><br><span class="line"><span class="number">101</span>      <span class="keyword">for</span> (; ph &lt; eph; ph ++) &#123;</span><br><span class="line"><span class="number">102</span>          readseg(ph-&gt;p_va &amp; <span class="number">0xFFFFFF</span>, ph-&gt;p_memsz, ph-&gt;p_offset);</span><br><span class="line"><span class="number">103</span>      &#125;</span><br><span class="line">        <span class="comment">// ELF文件0x1000位置后面的0xd1ec比特被载入内存0x00100000</span></span><br><span class="line">        <span class="comment">// ELF文件0xf000位置后面的0x1d20比特被载入内存0x0010e000</span></span><br><span class="line"><span class="number">104</span></span><br><span class="line"><span class="number">105</span>      <span class="comment">// 根据ELF头部储存的入口信息，找到内核的入口</span></span><br><span class="line"><span class="number">106</span>      <span class="comment">//注意：不返回 --死循环</span></span><br><span class="line"><span class="number">107</span>      ((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))(ELFHDR-&gt;e_entry &amp; <span class="number">0xFFFFFF</span>))();</span><br><span class="line"><span class="number">108</span></span><br><span class="line"><span class="number">109</span>  bad:</span><br><span class="line"><span class="number">110</span>      outw(<span class="number">0x8A00</span>, <span class="number">0x8A00</span>);</span><br><span class="line"><span class="number">111</span>      outw(<span class="number">0x8A00</span>, <span class="number">0x8E00</span>);</span><br><span class="line"><span class="number">112</span></span><br><span class="line"><span class="number">113</span>      <span class="comment">/* do nothing */</span></span><br><span class="line"><span class="number">114</span>      <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line"><span class="number">115</span>  &#125;</span><br><span class="line"><span class="number">116</span></span><br></pre></td></tr></table></figure></div>
<h1 id="练习5实现函数调用堆栈跟踪函数"><a class="markdownIt-Anchor" href="#练习5实现函数调用堆栈跟踪函数"></a> 练习5：实现函数调用堆栈跟踪函数</h1>
<p>我们需要在lab1中完成kdebug.c中函数print_stackframe的实现，可以通过函数print_stackframe来跟踪函数调用堆栈中记录的返回地址。在如果能够正确实现此函数，可在lab1中执行 “make qemu”后，在qemu模拟器中得到类似如下的输出：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">……</span><br><span class="line">ebp:0x00007b28 eip:0x00100992 args:0x00010094 0x00010094 0x00007b58 0x00100096</span><br><span class="line">    kern&#x2F;debug&#x2F;kdebug.c:305: print_stackframe+22</span><br><span class="line">ebp:0x00007b38 eip:0x00100c79 args:0x00000000 0x00000000 0x00000000 0x00007ba8</span><br><span class="line">    kern&#x2F;debug&#x2F;kmonitor.c:125: mon_backtrace+10</span><br><span class="line">ebp:0x00007b58 eip:0x00100096 args:0x00000000 0x00007b80 0xffff0000 0x00007b84</span><br><span class="line">    kern&#x2F;init&#x2F;init.c:48: grade_backtrace2+33</span><br><span class="line">ebp:0x00007b78 eip:0x001000bf args:0x00000000 0xffff0000 0x00007ba4 0x00000029</span><br><span class="line">    kern&#x2F;init&#x2F;init.c:53: grade_backtrace1+38</span><br><span class="line">ebp:0x00007b98 eip:0x001000dd args:0x00000000 0x00100000 0xffff0000 0x0000001d</span><br><span class="line">    kern&#x2F;init&#x2F;init.c:58: grade_backtrace0+23</span><br><span class="line">ebp:0x00007bb8 eip:0x00100102 args:0x0010353c 0x00103520 0x00001308 0x00000000</span><br><span class="line">    kern&#x2F;init&#x2F;init.c:63: grade_backtrace+34</span><br><span class="line">ebp:0x00007be8 eip:0x00100059 args:0x00000000 0x00000000 0x00000000 0x00007c53</span><br><span class="line">    kern&#x2F;init&#x2F;init.c:28: kern_init+88</span><br><span class="line">ebp:0x00007bf8 eip:0x00007d73 args:0xc031fcfa 0xc08ed88e 0x64e4d08e 0xfa7502a8</span><br><span class="line">&lt;unknow&gt;: -- 0x00007d72 –</span><br><span class="line">……</span><br></pre></td></tr></table></figure></div>
<p>请完成实验，看看输出是否与上述显示大致一致，并解释最后一行各个数值的含义。</p>
<p>提示：可阅读小节“函数堆栈”，了解编译器如何建立函数调用关系的。在完成lab1编译后，查看lab1/obj/bootblock.asm，了解bootloader源码与机器码的语句和地址等的对应关系；查看lab1/obj/kernel.asm，了解 ucore OS源码与机器码的语句和地址等的对应关系。</p>
<p>要求完成函数kern/debug/kdebug.c::print_stackframe的实现，提交改进后源代码包（可以编译执行），并在实验报告中简要说明实现过程，并写出对上述问题的回答。</p>
<p>当运行make qemu得到如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="BASH"><figure class="iseeu highlight /bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">moocos-&gt; make qemu</span><br><span class="line">(THU.CST) os is loading ...</span><br><span class="line"></span><br><span class="line">Special kernel symbols:</span><br><span class="line">  entry  0x00100000 (phys)</span><br><span class="line">  etext  0x00103209 (phys)</span><br><span class="line">  edata  0x0010da16 (phys)</span><br><span class="line">  end    0x0010ed20 (phys)</span><br><span class="line">Kernel executable memory footprint: 60KB</span><br><span class="line">++ setup timer interrupts</span><br></pre></td></tr></table></figure></div>
<p><a href="#bootblock.asm%E7%9A%84%E4%BB%A3%E7%A0%81">bootblock.asm源码</a></p>
<p>查看kern/debug/kdebug.c::print_stackframe</p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/OXh1cc4.png" alt="image-20200311151416667"></p>
<p>按照注释来做</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="C"><figure class="iseeu highlight /c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">print_stackframe(<span class="keyword">void</span>) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> ebp =read_ebp(), eip = read_eip();</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; ebp != <span class="number">0</span> &amp;&amp; i &lt; STACKFRAME_DEPTH; i ++)&#123;</span><br><span class="line">                cprintf(<span class="string">"ebp:0x%08x eip:0x%08x "</span>, ebp, eip);</span><br><span class="line">                <span class="keyword">uint32_t</span> *args = (<span class="keyword">uint32_t</span> *)ebp + <span class="number">2</span>;</span><br><span class="line">                cprintf(<span class="string">"args: 0x%08x 0x%08x 0x%08x 0x%08x"</span>, args[<span class="number">0</span>], args[<span class="number">1</span>], args[<span class="number">2</span>], args[<span class="number">3</span>]);</span><br><span class="line">                cprintf(<span class="string">"\n"</span>);</span><br><span class="line">                print_debuginfo(eip - <span class="number">1</span>);</span><br><span class="line">                eip = ((<span class="keyword">uint32_t</span> *)ebp)[<span class="number">1</span>];</span><br><span class="line">                ebp = ((<span class="keyword">uint32_t</span> *)ebp)[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>中cprintf表示控制台(console)输出</p>
<p>重新make qemu后</p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/MUGvbo9.png" alt="image-20200311154602152"></p>
<p>最后一行是</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ebp:0x00007bf8 eip:0x00007d68 args: 0xc031fcfa 0xc08ed88e 0x64e4d08e 0xfa7502a8</span><br></pre></td></tr></table></figure></div>
<p>共有ebp，eip和args三类参数</p>
<p><strong>函数调用栈</strong></p>
<p>函数开头</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pushl   %ebp</span><br><span class="line">movl   %esp , %ebp</span><br></pre></td></tr></table></figure></div>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/WGeprui.png" alt="函数调用栈"></p>
<p>这两条汇编指令的含义是：首先将ebp寄存器入栈，然后将栈顶指针esp赋值给ebp。“mov ebp esp”这条指令表面上看是用esp覆盖ebp原来的值，其实不然。因为给ebp赋值之前，原ebp值已经被压栈（位于栈顶），而新的ebp又恰恰指向栈顶。此时ebp寄存器就已经处于一个非常重要的地位，该寄存器中存储着栈中的一个地址（原ebp入栈后的栈顶），从该地址为基准，向上（栈底方向）能获取返回地址、参数值，向下（栈顶方向）能获取函数局部变量值，而该地址处又存储着上一层函数调用时的ebp值。</p>
<p>一般而言，EBP 基址指针，是保存调用者函数的地址，总是指向函数栈栈底，ESP被调函数的指针，总是指向函数栈栈顶。ss:[ebp+4]处为返回地址，ss:[ebp+8]处为第一个参数值（最后一个入栈的参数值，此处假设其占用4字节内存），ss:[ebp-4]处为第一个局部变量，ss:[ebp]处为上一层ebp值。</p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/fyyMdC8.png" alt="image-20200311170344228"></p>
<p>最后一行输出的ebp为<code>0x00007bf8</code>，eip为<code>0x00007d68</code>，这是因为bootloader被加载到了0x00007c00地址处，在执行到 [bootasm.S](#bootasm.S 源码)  最后&quot;call bootmain&quot;指令时，首先将返回地址压栈，再将当前ebp压栈，所以此时esp为0x00007bf8。ss:ebp+4指向caller调用时的eip在bootmain函数入口处，有mov %esp %ebp指令，故bootmain中ebp为0x00007bf8。</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">289      7cfc:       75 6a                   jne    7d68 &lt;bootmain+0x97&gt;</span><br><span class="line">394      7d68:       b8 00 8a ff ff          mov    $0xffff8a00,%eax</span><br></pre></td></tr></table></figure></div>
<p>ss:ebp+4指向caller调用时的eip，可以看到其地址。</p>
<p>一般来说，args存放的4个dword是对应4个输入参数的值。但这里比较特殊，由于bootmain函数调用时并没传递任何输入参数，并且栈顶的位置恰好在bootloader第一条指令存放的地址的上面，而args恰好是ebp寄存器指向的栈顶往上第2~5个单元，因此args存放的就是bootloader指令的前16个字节。可以对比obj/bootblock.asm文件来验证(其字节序为小端字节序)</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">14      7c00:       fa                      cli</span><br><span class="line">16      7c01:       fc                      cld</span><br><span class="line">20      7c02:       31 c0                   xor    %eax,%eax</span><br><span class="line">22      7c04:       8e d8                   mov    %eax,%ds</span><br><span class="line">24      7c06:       8e c0                   mov    %eax,%es</span><br><span class="line">26      7c08:       8e d0                   mov    %eax,%ss</span><br><span class="line">35      7c0a:       e4 64                   in     $0x64,%al</span><br><span class="line">37      7c0c:       a8 02                   test   $0x2,%al</span><br><span class="line">39      7c0e:       75 fa                   jne    7c0a &lt;seta20.1&gt;</span><br></pre></td></tr></table></figure></div>
<h1 id="练习6完善中断初始化和处理"><a class="markdownIt-Anchor" href="#练习6完善中断初始化和处理"></a> 练习6：完善中断初始化和处理</h1>
<p>请完成编码工作和回答如下问题：</p>
<ol>
<li>中断描述符表（也可简称为保护模式下的中断向量表）中一个表项占多少字节？其中哪几位代表中断处理代码的入口？</li>
<li>请编程完善kern/trap/trap.c中对中断向量表进行初始化的函数idt_init。在idt_init函数中，依次对所有中断入口进行初始化。使用mmu.h中的SETGATE宏，填充idt数组内容。每个中断的入口由tools/vectors.c生成，使用trap.c中声明的vectors数组即可。</li>
<li>请编程完善trap.c中的中断处理函数trap，在对时钟中断进行处理的部分填写trap函数中处理时钟中断的部分，使操作系统每遇到100次时钟中断后，调用print_ticks子程序，向屏幕上打印一行文字”100 ticks”。</li>
</ol>
<blockquote>
<p>【注意】除了系统调用中断(T_SYSCALL)使用陷阱门描述符且权限为用户态权限以外，其它中断均使用特权级(DPL)为０的中断门描述符，权限为内核态权限；而ucore的应用程序处于特权级３，需要采用｀int 0x80`指令操作（这种方式称为软中断，软件中断，Tra中断，在lab5会碰到）来发出系统调用请求，并要能实现从特权级３到特权级０的转换，所以系统调用中断(T_SYSCALL)所对应的中断门描述符中的特权级（DPL）需要设置为３。</p>
</blockquote>
<p>要求完成问题2和问题3 提出的相关函数实现，提交改进后的源代码包（可以编译执行），并在实验报告中简要说明实现过程，并写出对问题1的回答。完成这问题2和3要求的部分代码后，运行整个系统，可以看到大约每1秒会输出一次”100 ticks”，而按下的键也会在屏幕上显示。</p>
<h2 id="练习61"><a class="markdownIt-Anchor" href="#练习61"></a> 练习6.1</h2>
<p>中断描述符表（也可简称为保护模式下的中断向量表）中一个表项占多少字节？其中哪几位代表中断处理代码的入口？</p>
<p>中断向量表一个表项占用8字节，其中2-3字节是段选择子，0-1字节和6-7字节拼成位移，<br>
两者联合便是中断处理程序的入口地址。</p>
<h2 id="练习62"><a class="markdownIt-Anchor" href="#练习62"></a> 练习6.2</h2>
<p>kern/trap/trap.c的片段</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="C"><figure class="iseeu highlight /c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">34</span>  <span class="comment">/* idt_init - initialize IDT to each of the entry points in kern/trap/vectors.S */</span></span><br><span class="line"><span class="number">35</span>  <span class="keyword">void</span></span><br><span class="line"><span class="number">36</span>  idt_init(<span class="keyword">void</span>) &#123;</span><br><span class="line"><span class="number">37</span>       <span class="comment">/* LAB1 YOUR CODE : STEP 2 */</span></span><br><span class="line"><span class="number">38</span>       <span class="comment">/* (1) Where are the entry addrs of each Interrupt Service Routine (ISR)?</span></span><br><span class="line"><span class="comment">39        *     All ISR's entry addrs are stored in __vectors. where is uintptr_t __vectors[] ?</span></span><br><span class="line"><span class="comment">40        *     __vectors[] is in kern/trap/vector.S which is produced by tools/vector.c</span></span><br><span class="line"><span class="comment">41        *     (try "make" command in lab1, then you will find vector.S in kern/trap DIR)</span></span><br><span class="line"><span class="comment">42        *     You can use  "extern uintptr_t __vectors[];" to define this extern variable which will be used later.</span></span><br><span class="line"><span class="comment">43        * (2) Now you should setup the entries of ISR in Interrupt Description Table (IDT).</span></span><br><span class="line"><span class="comment">44        *     Can you see idt[256] in this file? Yes, it's IDT! you can use SETGATE macro to setup each item of IDT</span></span><br><span class="line"><span class="comment">45        * (3) After setup the contents of IDT, you will let CPU know where is the IDT by using 'lidt' instruction.</span></span><br><span class="line"><span class="comment">46        *     You don't know the meaning of this instruction? just google it! and check the libs/x86.h to know more.</span></span><br><span class="line"><span class="comment">47        *     Notice: the argument of lidt is idt_pd. try to find it!</span></span><br><span class="line"><span class="comment">48        */</span></span><br><span class="line"><span class="number">49</span>  &#125;</span><br></pre></td></tr></table></figure></div>
<p>kern/mm/mmu.h中的SETGATE宏</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="C"><figure class="iseeu highlight /c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">71</span>  <span class="meta">#<span class="meta-keyword">define</span> SETGATE(gate, istrap, sel, off, dpl) &#123;            \</span></span><br><span class="line"><span class="number">72</span>      (gate).gd_off_15_0 = (<span class="keyword">uint32_t</span>)(off) &amp; <span class="number">0xffff</span>;        \</span><br><span class="line"><span class="number">73</span>      (gate).gd_ss = (sel);                                \</span><br><span class="line"><span class="number">74</span>      (gate).gd_args = <span class="number">0</span>;                                    \</span><br><span class="line"><span class="number">75</span>      (gate).gd_rsv1 = <span class="number">0</span>;                                    \</span><br><span class="line"><span class="number">76</span>      (gate).gd_type = (istrap) ? STS_TG32 : STS_IG32;    \</span><br><span class="line"><span class="number">77</span>      (gate).gd_s = <span class="number">0</span>;                                    \</span><br><span class="line"><span class="number">78</span>      (gate).gd_dpl = (dpl);                                \</span><br><span class="line"><span class="number">79</span>      (gate).gd_p = <span class="number">1</span>;                                    \</span><br><span class="line"><span class="number">80</span>      (gate).gd_off_31_16 = (<span class="keyword">uint32_t</span>)(off) &gt;&gt; <span class="number">16</span>;        \</span><br><span class="line"><span class="number">81</span>  &#125;</span><br></pre></td></tr></table></figure></div>
<p>补全函数如下</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="C"><figure class="iseeu highlight /c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">uintptr_t</span> __vectors[];</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>;  i &lt; <span class="number">256</span>; i ++)&#123;</span><br><span class="line">        SETGATE(idt[i], <span class="number">0</span>, GD_KTEXT, __vectors[i], DPL_KERNEL);</span><br><span class="line">&#125;</span><br><span class="line">SETGATE(idt[T_SWITCH_TOK], <span class="number">0</span>, GD_KTEXT, __vectors[T_SWITCH_TOK], DPL_USER);</span><br><span class="line">lidt(&amp;idt_pd);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> 传入的第一个参数gate是中断的描述符表</span></span><br><span class="line"><span class="comment"> 传入的第二个参数istrap用来判断是中断还是trap</span></span><br><span class="line"><span class="comment"> 传入的第三个参数sel的作用是进行段的选择</span></span><br><span class="line"><span class="comment"> 传入的第四个参数off表示偏移</span></span><br><span class="line"><span class="comment"> 传入的第五个参数dpl表示这个中断的优先级</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></div>
<h2 id="练习63"><a class="markdownIt-Anchor" href="#练习63"></a> 练习6.3</h2>
<p>请编程完善trap.c中的中断处理函数trap，在对时钟中断进行处理的部分填写trap函数中处理时钟中断的部分，使操作系统每遇到100次时钟中断后，调用print_ticks子程序，向屏幕上打印一行文字”100 ticks”。</p>
<p>提示片段</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="C"><figure class="iseeu highlight /c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* LAB1 YOUR CODE : STEP 3 */</span></span><br><span class="line"><span class="comment">/* handle the timer interrupt */</span></span><br><span class="line"><span class="comment">/* (1) After a timer interrupt, you should record this event using a global variable (increase it), such as ticks in kern/driver/clock.c</span></span><br><span class="line"><span class="comment"> * (2) Every TICK_NUM cycle, you can print some info using a funciton, such as print_ticks().</span></span><br><span class="line"><span class="comment"> * (3) Too Simple? Yes, I think so!</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure></div>
<p>补充如下</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="C"><figure class="iseeu highlight /c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ticks++;</span><br><span class="line"><span class="keyword">if</span>(ticks%TICK_NUM == <span class="number">0</span>)<span class="comment">//每次时钟中断之后ticks就会加一 当加到TICK_NUM次数时 打印并重新开始</span></span><br><span class="line">print_ticks();<span class="comment">//前面有定义 打印字符串</span></span><br></pre></td></tr></table></figure></div>
<p>运行make qemu显示如下</p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/CazTG2S.png" alt="image-20200311180818859"></p>
<h1 id="扩展练习-challenge-1"><a class="markdownIt-Anchor" href="#扩展练习-challenge-1"></a> 扩展练习 Challenge 1</h1>
<p>扩展proj4,增加syscall功能，即增加一用户态函数（可执行一特定系统调用：获得时钟计数值），当内核初始完毕后，可从内核态返回到用户态的函数，而用户态的函数又通过系统调用得到内核态的服务。</p>
<p>提示： 规范一下 challenge 的流程。</p>
<p>kern_init 调用 switch_test，该函数如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">static void</span><br><span class="line">switch_test(void) &#123;</span><br><span class="line">    print_cur_status();          &#x2F;&#x2F; print 当前 cs&#x2F;ss&#x2F;ds 等寄存器状态</span><br><span class="line">    cprintf(&quot;+++ switch to  user  mode +++\n&quot;);</span><br><span class="line">    switch_to_user();            &#x2F;&#x2F; switch to user mode</span><br><span class="line">    print_cur_status();</span><br><span class="line">    cprintf(&quot;+++ switch to kernel mode +++\n&quot;);</span><br><span class="line">    switch_to_kernel();         &#x2F;&#x2F; switch to kernel mode</span><br><span class="line">    print_cur_status();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>switchto函数建议通过 中断处理的方式实现。主要要完成的代码是在 trap 里面处理 T_SWITCH_TO* 中断，并设置好返回的状态。</p>
<p>在 lab1 里面完成代码以后，执行 make grade 应该能够评测结果是否正确。</p>
<p><font face="黑体" color="black" size="6.5">Solution:</font></p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="C"><figure class="iseeu highlight /c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">kern/init/init.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">lab1_switch_to_user</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//LAB1 CHALLENGE 1 : TODO</span></span><br><span class="line"><span class="comment">/*--------------------------------------------------------</span></span><br><span class="line"><span class="comment">    "sub $0x8, %%esp \n" </span></span><br><span class="line"><span class="comment">    让 SS 和 ESP 这两个寄存器 有机会 POP 出时 更新 SS 和 ESP</span></span><br><span class="line"><span class="comment">    因为 从内核态进入中断 它的特权级没有改变 是不会 push 进 SS 和 ESP的 但是我们又需要通过 POP SS 和 ESP 去修改它们</span></span><br><span class="line"><span class="comment">    进入 T_SWITCH_TOU(120) 中断</span></span><br><span class="line"><span class="comment">    将原来的栈顶指针还给esp栈底指针</span></span><br><span class="line"><span class="comment">--------------------------------------------------------*/</span></span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">"sub $0x8, %%esp \n"</span></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">"int %0 \n"</span></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">"movl %%ebp, %%esp"</span></span></span></span><br><span class="line"><span class="function"><span class="params">        : </span></span></span><br><span class="line"><span class="function"><span class="params">        : <span class="string">"i"</span>(T_SWITCH_TOU)</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">lab1_switch_to_kernel</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//LAB1 CHALLENGE 1 :  TOD</span></span><br><span class="line"><span class="comment">/*--------------------------------------------------------</span></span><br><span class="line"><span class="comment">    进入 T_SWITCH_TOK(121) 中断</span></span><br><span class="line"><span class="comment">    将原来的栈顶指针还给esp栈底指针</span></span><br><span class="line"><span class="comment">--------------------------------------------------------*/</span></span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">"int %0 \n"</span></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">"movl %%ebp, %%esp \n"</span></span></span></span><br><span class="line"><span class="function"><span class="params">        : </span></span></span><br><span class="line"><span class="function"><span class="params">        : <span class="string">"i"</span>(T_SWITCH_TOK)</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kern/trap/trap.c :</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 定义临时指针 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trapframe</span> <span class="title">switchk2u</span>, *<span class="title">switchu2k</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">trap_dispatch</span><span class="params">(struct trapframe *tf)</span></span></span><br><span class="line"><span class="function"><span class="comment">//通过"改造"一个中断 来进入我们想进入的用户态或者内核态</span></span></span><br><span class="line">    case T_SWITCH_TOU:</span><br><span class="line">        <span class="keyword">if</span> (tf-&gt;tf_cs != USER_CS) &#123;</span><br><span class="line">            switchk2u = *tf;</span><br><span class="line">            switchk2u.tf_cs = USER_CS;</span><br><span class="line">            switchk2u.tf_ds = switchk2u.tf_es = switchk2u.tf_ss = USER_DS;</span><br><span class="line">            switchk2u.tf_eflags |= FL_IOPL_MASK; <span class="comment">// IOPL 改为 0</span></span><br><span class="line">            switchk2u.tf_esp = (<span class="keyword">uint32_t</span>)tf + <span class="keyword">sizeof</span>(struct trapframe) - <span class="number">8</span>; <span class="comment">// tf-&gt;esp的位置</span></span><br><span class="line">            <span class="comment">// iret 回到用户栈</span></span><br><span class="line">            *((<span class="keyword">uint32_t</span> *)tf - <span class="number">1</span>) = (<span class="keyword">uint32_t</span>)&amp;switchk2u;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> T_SWITCH_TOK:</span><br><span class="line">        <span class="keyword">if</span> (tf-&gt;tf_cs != KERNEL_CS) &#123;</span><br><span class="line">            tf-&gt;tf_cs = KERNEL_CS;</span><br><span class="line">            tf-&gt;tf_ds = tf-&gt;tf_es = KERNEL_DS;</span><br><span class="line">            tf-&gt;tf_eflags &amp;= ~FL_IOPL_MASK;</span><br><span class="line">            switchu2k = (struct trapframe *)(tf-&gt;tf_esp - (<span class="keyword">sizeof</span>(struct trapframe) - <span class="number">8</span>));</span><br><span class="line">            memmove(switchu2k, tf, <span class="keyword">sizeof</span>(struct trapframe) - <span class="number">8</span>);</span><br><span class="line">            *((<span class="keyword">uint32_t</span> *)tf - <span class="number">1</span>) = (<span class="keyword">uint32_t</span>)switchu2k;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></div>
<p>去掉42行注释</p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/c5hPayt.png" alt="image-20200311193059728"></p>
<p>运行<code>make grade</code></p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/dtfEPFo.png" alt="image-20200311194238755"></p>
<p>莫名其妙的满分。。。</p>
<h1 id="扩展练习-challenge-2"><a class="markdownIt-Anchor" href="#扩展练习-challenge-2"></a> 扩展练习 Challenge 2</h1>
<p>用键盘实现用户模式内核模式切换。具体目标是：“键盘输入3时切换到用户模式，键盘输入0时切换到内核模式”。 基本思路是借鉴软中断(syscall功能)的代码，并且把trap.c中软中断处理的设置语句拿过来。</p>
<p>注意：</p>
<p>1.关于调试工具，不建议用lab1_print_cur_status()来显示，要注意到寄存器的值要在中断完成后tranentry.S里面iret结束的时候才写回，所以再trap.c里面不好观察，建议用print_trapframe(tf)</p>
<p>2.关于内联汇编，最开始调试的时候，参数容易出现错误，可能的错误代码如下</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">asm volatile ( &quot;sub $0x8, %%esp \n&quot;</span><br><span class="line">  &quot;int %0 \n&quot;</span><br><span class="line">  &quot;movl %%ebp, %%esp&quot;</span><br><span class="line">  : )</span><br></pre></td></tr></table></figure></div>
<p>要去掉参数int %0 \n这一行</p>
<p>3.软中断是利用了临时栈来处理的，所以有压栈和出栈的汇编语句。硬件中断本身就在内核态了，直接处理就可以了。</p>
<p><font face="黑体" color="black" size="6.5">Solution:</font></p>
<p>补充代码</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="C"><figure class="iseeu highlight /c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kern/trap/trap.c</span><br><span class="line"><span class="comment">// 173行  </span></span><br><span class="line"><span class="keyword">case</span> IRQ_OFFSET + IRQ_KBD:</span><br><span class="line">        c = cons_getc();</span><br><span class="line">        cprintf(<span class="string">"kbd [%03d] %c\n"</span>, c, c);</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">'0'</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tf-&gt;tf_cs != KERNEL_CS) &#123;</span><br><span class="line">                tf-&gt;tf_cs = KERNEL_CS;</span><br><span class="line">                tf-&gt;tf_ds = tf-&gt;tf_ss = tf-&gt;tf_es = KERNEL_DS;</span><br><span class="line">                tf-&gt;tf_eflags &amp;= ~FL_IOPL_MASK;</span><br><span class="line">            &#125;</span><br><span class="line">            print_trapframe(tf);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">'3'</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tf-&gt;tf_cs != USER_CS) &#123;</span><br><span class="line">                tf-&gt;tf_cs = USER_CS;</span><br><span class="line">                tf-&gt;tf_ds = tf-&gt;tf_ss = tf-&gt;tf_es = USER_DS;</span><br><span class="line">                tf-&gt;tf_eflags |= FL_IOPL_MASK;</span><br><span class="line">            &#125;</span><br><span class="line">            print_trapframe(tf);</span><br><span class="line">        &#125;</span><br><span class="line">	   <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></div>
<p>make qemu</p>
<p>键盘输入3时切换到用户模式</p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/SpfyqZo.png" alt="image-20200311203258304"></p>
<p>键盘输入0时切换到内核模式</p>
<p><img src="/images/loading.gif" data-original="/posts/335ac3b4/ChQUgEX.png" alt="image-20200311203152425"></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E5%AD%A6%E4%B9%A0/" rel="tag"><i class="fa fa-tag"></i> 学习</a>
          
        </div>
      
		<div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/posts/335ac3b4/">ucoreOS lab1 实验报告</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 Mingkwind 的个人博客">Mingkwind</a></p>
  <p><span>发布时间:</span>2020年03月13日 - 10:07</p>
  <p><span>最后更新:</span>2022年04月09日 - 23:16</p>
  <p><span>原始链接:</span><a href="/posts/335ac3b4/" title="ucoreOS lab1 实验报告">https://mingkwind.github.io/posts/335ac3b4/</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://mingkwind.github.io/posts/335ac3b4/"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
      $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
        });
    });  
</script>

      
		</div>
      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/posts/349c41ac/" rel="next" title="hexo标题抖音特效">
                <i class="fa fa-chevron-left"></i> hexo标题抖音特效
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/posts/f4345ea0/" rel="prev" title="修改hexo默认字体颜色">
                修改hexo默认字体颜色 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="Mingkwind" />
            
              <p class="site-author-name" itemprop="name">Mingkwind</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                
				<a href="/archives/">
              
                  <span class="site-state-item-count">69</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/mingkwind" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/964586dd07f2" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-edit"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="/atom.xml" target="_blank" title="RSS">
                      
                        <i class="fa fa-fw fa-rss"></i></a>
                  </span>
                
            </div>
          

          
          

          
          

          <script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5te927ym7vp&amp;m=0&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33" async="async"></script>

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#练习1理解通过make生成执行文件的过程"><span class="nav-number">1.</span> <span class="nav-text"> 练习1：理解通过make生成执行文件的过程。</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#练习2使用qemu执行并调试lab1中的软件"><span class="nav-number">2.</span> <span class="nav-text"> 练习2：使用qemu执行并调试lab1中的软件。</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#练习21"><span class="nav-number">2.1.</span> <span class="nav-text"> 练习2.1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#练习22"><span class="nav-number">2.2.</span> <span class="nav-text"> 练习2.2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#练习23"><span class="nav-number">2.3.</span> <span class="nav-text"> 练习2.3</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#bootblockasm的代码"><span class="nav-number">2.3.1.</span> <span class="nav-text"> bootblock.asm的代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#练习24"><span class="nav-number">2.4.</span> <span class="nav-text"> 练习2.4</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#练习3分析bootloader进入保护模式的过程"><span class="nav-number">3.</span> <span class="nav-text"> 练习3：分析bootloader进入保护模式的过程。</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#bootasms-源码"><span class="nav-number">3.1.</span> <span class="nav-text"> bootasm.S 源码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#练习31"><span class="nav-number">3.2.</span> <span class="nav-text"> 练习3.1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#练习32"><span class="nav-number">3.3.</span> <span class="nav-text"> 练习3.2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#练习33"><span class="nav-number">3.4.</span> <span class="nav-text"> 练习3.3</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#练习4分析bootloader加载elf格式的os的过程"><span class="nav-number">4.</span> <span class="nav-text"> 练习4：分析bootloader加载ELF格式的OS的过程。</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#bootmainc源码"><span class="nav-number">4.1.</span> <span class="nav-text"> bootmain.c源码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#练习41"><span class="nav-number">4.2.</span> <span class="nav-text"> 练习4.1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#练习42"><span class="nav-number">4.3.</span> <span class="nav-text"> 练习4.2</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#练习5实现函数调用堆栈跟踪函数"><span class="nav-number">5.</span> <span class="nav-text"> 练习5：实现函数调用堆栈跟踪函数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#练习6完善中断初始化和处理"><span class="nav-number">6.</span> <span class="nav-text"> 练习6：完善中断初始化和处理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#练习61"><span class="nav-number">6.1.</span> <span class="nav-text"> 练习6.1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#练习62"><span class="nav-number">6.2.</span> <span class="nav-text"> 练习6.2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#练习63"><span class="nav-number">6.3.</span> <span class="nav-text"> 练习6.3</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#扩展练习-challenge-1"><span class="nav-number">7.</span> <span class="nav-text"> 扩展练习 Challenge 1</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#扩展练习-challenge-2"><span class="nav-number">8.</span> <span class="nav-text"> 扩展练习 Challenge 2</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Asymptotic-freedom</span>

  
  <div class="powered-by">
	<i class="fa fa-user-md"></i>
	<span id="busuanzi_container_site_uv">
		本站访客数:<span id="busuanzi_value_site_uv"></span>
	</span>
	<span class="post-meta-divider">|</span>
	<span id="busuanzi_container_site_pv">
		本站访问量<span id="busuanzi_value_site_pv"></span>
	</span>
  </div>
</div>









  <script src='https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>


        







        
      </div>
    </footer>

	

    
	

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

  
  <!-- 旋转魔方 -->

   
      <style>
  /*最外层容器样式*/
  .wrap {
    width: 0px;
    height: 0px;
    /*margin: 80px;*/
    /*position: relative;*/
    position: fixed;
      /*显示位置*/
    bottom: 200px;
    right: 70px;
    z-index: 999;
  }

  /*包裹所有容器样式*/
  .cube {
    width: 0px;
    height: 0px;
    margin: 0 auto;
    -webkit-transform-style: preserve-3d;
    transform-style: preserve-3d;
    transform: rotateX(-30deg) rotateY(-80deg);
    animation: rotate linear 10s infinite;
  }

  @-webkit-keyframes rotate {
    from {
      transform: rotateX(0deg) rotateY(0deg);
    }
    to {
      transform: rotateX(360deg) rotateY(360deg);
    }
  }

  .cube div {
    position: absolute;
    /*显示大小*/
    width: 50px;
    height: 50px;
    opacity: 0.8;
    transition: all .4s;
  }

  /*定义所有图片样式*/
  .pic {
    width: 50px;
    height: 50px;
  }

  .cube .out_front {
    transform: rotateY(0deg) translateZ(25px);
  }

  .cube .out_back {
    transform: translateZ(-25px) rotateY(180deg);
  }

  .cube .out_left {
    transform: rotateY(-90deg) translateZ(25px);
  }

  .cube .out_right {
    transform: rotateY(90deg) translateZ(25px);
  }

  .cube .out_top {
    transform: rotateX(90deg) translateZ(25px);
  }

  .cube .out_bottom {
    transform: rotateX(-90deg) translateZ(25px);
  }

  /*定义小正方体样式*/
  .cube span {
    display: block;
    width: 25px;
    height: 25px;
    position: absolute;
    top: 12px;
    left: 12px;
  }

  .cube .in_pic {
    width: 25px;
    height:25px;
  }

  .cube .in_front {
    transform: rotateY(0deg) translateZ(12px);
  }

  .cube .in_back {
    transform: translateZ(-12px) rotateY(180deg);
  }

  .cube .in_left {
    transform: rotateY(-90deg) translateZ(12px);
  }

  .cube .in_right {
    transform: rotateY(90deg) translateZ(12px);
  }

  .cube .in_top {
    transform: rotateX(90deg) translateZ(12px);
  }

  .cube .in_bottom {
    transform: rotateX(-90deg) translateZ(12px);
  }

  /*鼠标移入后样式*/
  .cube:hover .out_front {
    transform: rotateY(0deg) translateZ(50px);
  }

  .cube:hover .out_back {
    transform: translateZ(-50px) rotateY(180deg);
  }

  .cube:hover .out_left {
    transform: rotateY(-90deg) translateZ(50px);
  }

  .cube:hover .out_right {
    transform: rotateY(90deg) translateZ(50px);
  }

  .cube:hover .out_top {
    transform: rotateX(90deg) translateZ(50px);
  }

  .cube:hover .out_bottom {
    transform: rotateX(-90deg) translateZ(50px);
  }
</style>

<!--图片路径https://raw.githubusercontent.com/Aurthoria/Pictures/master/img/20200309224636.png-->

<div class="wrap">

    <!--包裹所有元素的容器-->
    <div class="cube">
        <!--前面图片 -->
        <div class="out_front">
          <a onclick="back2top()">
              <img src="https://i.imgur.com/AZULc9Y.png" class="pic" />
            </a>
        </div>
        <!--后面图片 -->
        <div class="out_back">
            <a onclick="back2top()">
              <img src="https://i.imgur.com/AZULc9Y.png" class="pic" />
            </a>
        </div>
        <!--左面图片 -->
        <div class="out_left">
            <a onclick="back2top()">
              <img src="https://i.imgur.com/AZULc9Y.png" class="pic" />
            </a>
        </div>
        <!--右面图片 -->
        <div class="out_right">
            <a onclick="back2top()">
                <img src="https://i.imgur.com/AZULc9Y.png" class="pic" />
            </a>
        </div>
        <!--上面图片 -->
        <div class="out_top">
            <a onclick="back2top()">
                <img src="https://i.imgur.com/AZULc9Y.png" class="pic" />
            </a>
        </div>
        <!--下面图片 -->
        <div class="out_bottom">
            <a onclick="back2top()">
                <img src="https://i.imgur.com/AZULc9Y.png" class="pic" />
            </a>
        </div>

        <!--小正方体 -->
        <span class="in_front">
            <img src="https://i.imgur.com/AZULc9Y.png" class="in_pic" />
        </span>
        <span class="in_back">
             <img src="https://i.imgur.com/AZULc9Y.png" class="in_pic" />
        </span>
        <span class="in_left">
            <img src="https://i.imgur.com/AZULc9Y.png" class="in_pic" />
        </span>
        <span class="in_right">
            <img src="https://i.imgur.com/AZULc9Y.png" class="in_pic" />
        </span>
        <span class="in_top">
            <img src="https://i.imgur.com/AZULc9Y.png" class="in_pic" />
        </span>
        <span class="in_bottom">
            <img src="https://i.imgur.com/AZULc9Y.png" class="in_pic" />
        </span>
    </div>
</div>

<script>
  function back2top(){
    $('html, body').animate({scrollTop: 0}, 500);
  }
</script>
   



  <canvas id="evanyou"></canvas>
  <style>
    #evanyou {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: -1;
    }
  </style>
  <script src="/js/evan-you.js"></script>


<!-- 代码复制 -->
<script type="text/javascript" src="/js/src/clipboard.min.js"></script>
<script type="text/javascript" src="/js/src/clipboard-use.js"></script>



  <script src="/js/activate-power-mode.min.js"></script>
  <script>
    POWERMODE.colorful = true;
    POWERMODE.shake = false;
    document.body.addEventListener('input', POWERMODE);
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

<script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
<!-- 看板娘 -->
<script src="/live2d-widget/autoload.js"></script>
<!--崩溃欺骗-->
<script type="text/javascript" src="/js/src/crash_cheat.js"></script>